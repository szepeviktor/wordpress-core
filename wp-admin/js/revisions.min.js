window.wp=window.wp||{},function(t){var e;e=wp.revisions={model:{},view:{},controller:{}},e.settings=window._wpRevisionsSettings||{},e.debug=!1,e.log=function(){window.console&&e.debug&&window.console.log.apply(window.console,arguments)},t.fn.allOffsets=function(){var e=this.offset()||{top:0,left:0},i=t(window);return _.extend(e,{right:i.width()-e.left-this.outerWidth(),bottom:i.height()-e.top-this.outerHeight()})},t.fn.allPositions=function(){var t=this.position()||{top:0,left:0},e=this.parent();return _.extend(t,{right:e.outerWidth()-t.left-this.outerWidth(),bottom:e.outerHeight()-t.top-this.outerHeight()})},e.model.Slider=Backbone.Model.extend({defaults:{value:null,values:null,min:0,max:1,step:1,range:!1,compareTwoMode:!1},initialize:function(t){this.frame=t.frame,this.revisions=t.revisions,this.listenTo(this.frame,"update:revisions",this.receiveRevisions),this.listenTo(this.frame,"change:compareTwoMode",this.updateMode),this.on("change:from",this.handleLocalChanges),this.on("change:to",this.handleLocalChanges),this.on("change:compareTwoMode",this.updateSliderSettings),this.on("update:revisions",this.updateSliderSettings),this.on("change:hoveredRevision",this.hoverRevision),this.set({max:this.revisions.length-1,compareTwoMode:this.frame.get("compareTwoMode"),from:this.frame.get("from"),to:this.frame.get("to")}),this.updateSliderSettings()},getSliderValue:function(t,e){return isRtl?this.revisions.length-this.revisions.indexOf(this.get(t))-1:this.revisions.indexOf(this.get(e))},updateSliderSettings:function(){this.get("compareTwoMode")?this.set({values:[this.getSliderValue("to","from"),this.getSliderValue("from","to")],value:null,range:!0}):this.set({value:this.getSliderValue("to","to"),values:null,range:!1}),this.trigger("update:slider")},hoverRevision:function(t,e){this.trigger("hovered:revision",e)},updateMode:function(t,e){this.set({compareTwoMode:e})},handleLocalChanges:function(){this.frame.set({from:this.get("from"),to:this.get("to")})},receiveRevisions:function(t,e){this.get("from")===t&&this.get("to")===e||(this.set({from:t,to:e},{silent:!0}),this.trigger("update:revisions",t,e))}}),e.model.Tooltip=Backbone.Model.extend({defaults:{revision:null,offset:{},hovering:!1,scrubbing:!1},initialize:function(t){this.frame=t.frame,this.revisions=t.revisions,this.slider=t.slider,this.listenTo(this.slider,"hovered:revision",this.updateRevision),this.listenTo(this.slider,"change:hovering",this.setHovering),this.listenTo(this.slider,"change:scrubbing",this.setScrubbing)},updateRevision:function(t){this.set({revision:t})},setHovering:function(t,e){this.set({hovering:e})},setScrubbing:function(t,e){this.set({scrubbing:e})}}),e.model.Revision=Backbone.Model.extend({}),e.model.Revisions=Backbone.Collection.extend({model:e.model.Revision,initialize:function(){_.bindAll(this,"next","prev")},next:function(t){var e=this.indexOf(t);if(-1!==e&&e!==this.length-1)return this.at(e+1)},prev:function(t){var e=this.indexOf(t);if(-1!==e&&0!==e)return this.at(e-1)}}),e.model.Field=Backbone.Model.extend({}),e.model.Fields=Backbone.Collection.extend({model:e.model.Field}),e.model.Diff=Backbone.Model.extend({initialize:function(){var t=this.get("fields");this.unset("fields"),this.fields=new e.model.Fields(t)}}),e.model.Diffs=Backbone.Collection.extend({initialize:function(t,e){_.bindAll(this,"getClosestUnloaded"),this.loadAll=_.once(this._loadAll),this.revisions=e.revisions,this.postId=e.postId,this.requests={}},model:e.model.Diff,ensure:function(e,i){var s=this.get(e),r=this.requests[e],n=t.Deferred(),a={},o=e.split(":")[0],h=e.split(":")[1];return a[e]=!0,wp.revisions.log("ensure",e),this.trigger("ensure",a,o,h,n.promise()),s?n.resolveWith(i,[s]):(this.trigger("ensure:load",a,o,h,n.promise()),_.each(a,_.bind(function(t){this.requests[t]&&delete a[t],this.get(t)&&delete a[t]},this)),r||(a[e]=!0,r=this.load(_.keys(a))),r.done(_.bind(function(){n.resolveWith(i,[this.get(e)])},this)).fail(_.bind(function(){n.reject()}))),n.promise()},getClosestUnloaded:function(t,e){var i=this;return _.chain([0].concat(t)).initial().zip(t).sortBy(function(t){return Math.abs(e-t[1])}).map(function(t){return t.join(":")}).filter(function(t){return _.isUndefined(i.get(t))&&!i.requests[t]}).value()},_loadAll:function(e,i,s){var r=this,n=t.Deferred(),a=_.first(this.getClosestUnloaded(e,i),s);return _.size(a)>0?this.load(a).done(function(){r._loadAll(e,i,s).done(function(){n.resolve()})}).fail(function(){1===s?n.reject():r._loadAll(e,i,Math.ceil(s/2)).done(function(){n.resolve()})}):n.resolve(),n},load:function(t){return wp.revisions.log("load",t),this.fetch({data:{compare:t},remove:!1}).done(function(){wp.revisions.log("load:complete",t)})},sync:function(t,e,i){if("read"===t){i=i||{},i.context=this,i.data=_.extend(i.data||{},{action:"get-revision-diffs",post_id:this.postId});var s=wp.ajax.send(i),r=this.requests;return i.data.compare&&_.each(i.data.compare,function(t){r[t]=s}),s.always(function(){i.data.compare&&_.each(i.data.compare,function(t){delete r[t]})}),s}return Backbone.Model.prototype.sync.apply(this,arguments)}}),e.model.FrameState=Backbone.Model.extend({defaults:{loading:!1,error:!1,compareTwoMode:!1},initialize:function(t,i){var s=this.get("initialDiffState");_.bindAll(this,"receiveDiff"),this._debouncedEnsureDiff=_.debounce(this._ensureDiff,200),this.revisions=i.revisions,this.diffs=new e.model.Diffs([],{revisions:this.revisions,postId:this.get("postId")}),this.diffs.set(this.get("diffData")),this.listenTo(this,"change:from",this.changeRevisionHandler),this.listenTo(this,"change:to",this.changeRevisionHandler),this.listenTo(this,"change:compareTwoMode",this.changeMode),this.listenTo(this,"update:revisions",this.updatedRevisions),this.listenTo(this.diffs,"ensure:load",this.updateLoadingStatus),this.listenTo(this,"update:diff",this.updateLoadingStatus),this.set({to:this.revisions.get(s.to),from:this.revisions.get(s.from),compareTwoMode:s.compareTwoMode}),window.history&&window.history.pushState&&(this.router=new e.Router({model:this}),Backbone.History.started&&Backbone.history.stop(),Backbone.history.start({pushState:!0}))},updateLoadingStatus:function(){this.set("error",!1),this.set("loading",!this.diff())},changeMode:function(t,e){var i=this.revisions.indexOf(this.get("to"));e&&0===i&&this.set({from:this.revisions.at(i),to:this.revisions.at(i+1)}),e||0===i||this.set({from:this.revisions.at(i-1),to:this.revisions.at(i)})},updatedRevisions:function(t,e){this.get("compareTwoMode")||this.diffs.loadAll(this.revisions.pluck("id"),e.id,40)},diff:function(){return this.diffs.get(this._diffId)},updateDiff:function(e){var i,s,r,n;return e=e||{},i=this.get("from"),s=this.get("to"),r=(i?i.id:0)+":"+s.id,this._diffId===r?t.Deferred().reject().promise():(this._diffId=r,this.trigger("update:revisions",i,s),n=this.diffs.get(r),n?(this.receiveDiff(n),t.Deferred().resolve().promise()):e.immediate?this._ensureDiff():(this._debouncedEnsureDiff(),t.Deferred().reject().promise()))},changeRevisionHandler:function(){this.updateDiff()},receiveDiff:function(t){_.isUndefined(t)||_.isUndefined(t.id)?this.set({loading:!1,error:!0}):this._diffId===t.id&&this.trigger("update:diff",t)},_ensureDiff:function(){return this.diffs.ensure(this._diffId,this).always(this.receiveDiff)}}),e.view.Frame=wp.Backbone.View.extend({className:"revisions",template:wp.template("revisions-frame"),initialize:function(){this.listenTo(this.model,"update:diff",this.renderDiff),this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode),this.listenTo(this.model,"change:loading",this.updateLoadingStatus),this.listenTo(this.model,"change:error",this.updateErrorStatus),this.views.set(".revisions-control-frame",new e.view.Controls({model:this.model}))},render:function(){return wp.Backbone.View.prototype.render.apply(this,arguments),t("html").css("overflow-y","scroll"),t("#wpbody-content .wrap").append(this.el),this.updateCompareTwoMode(),this.renderDiff(this.model.diff()),this.views.ready(),this},renderDiff:function(t){this.views.set(".revisions-diff-frame",new e.view.Diff({model:t}))},updateLoadingStatus:function(){this.$el.toggleClass("loading",this.model.get("loading"))},updateErrorStatus:function(){this.$el.toggleClass("diff-error",this.model.get("error"))},updateCompareTwoMode:function(){this.$el.toggleClass("comparing-two-revisions",this.model.get("compareTwoMode"))}}),e.view.Controls=wp.Backbone.View.extend({className:"revisions-controls",initialize:function(){_.bindAll(this,"setWidth"),this.views.add(new e.view.Buttons({model:this.model})),this.views.add(new e.view.Checkbox({model:this.model}));var t=new e.model.Slider({frame:this.model,revisions:this.model.revisions}),i=new e.model.Tooltip({frame:this.model,revisions:this.model.revisions,slider:t});this.views.add(new e.view.Tooltip({model:i})),this.views.add(new e.view.Tickmarks({model:i})),this.views.add(new e.view.Slider({model:t})),this.views.add(new e.view.Metabox({model:this.model}))},ready:function(){this.top=this.$el.offset().top,this.window=t(window),this.window.on("scroll.wp.revisions",{controls:this},function(t){var e=t.data.controls,i=e.$el.parent(),s=e.window.scrollTop(),r=e.views.parent;s>=e.top?(r.$el.hasClass("pinned")||(e.setWidth(),i.css("height",i.height()+"px"),e.window.on("resize.wp.revisions.pinning click.wp.revisions.pinning",{controls:e},function(t){t.data.controls.setWidth()})),r.$el.addClass("pinned")):r.$el.hasClass("pinned")?(e.window.off(".wp.revisions.pinning"),e.$el.css("width","auto"),r.$el.removeClass("pinned"),i.css("height","auto"),e.top=e.$el.offset().top):e.top=e.$el.offset().top})},setWidth:function(){this.$el.css("width",this.$el.parent().width()+"px")}}),e.view.Tickmarks=wp.Backbone.View.extend({className:"revisions-tickmarks",direction:isRtl?"right":"left",initialize:function(){this.listenTo(this.model,"change:revision",this.reportTickPosition)},reportTickPosition:function(t,e){var i,s,r,n,a=this.model.revisions.indexOf(e);s=this.$el.allOffsets(),r=this.$el.parent().allOffsets(),a===this.model.revisions.length-1?i={rightPlusWidth:s.left-r.left+1,leftPlusWidth:s.right-r.right+1}:(n=this.$("div:nth-of-type("+(a+1)+")"),i=n.allPositions(),_.extend(i,{left:i.left+s.left-r.left,right:i.right+s.right-r.right}),_.extend(i,{leftPlusWidth:i.left+n.outerWidth(),rightPlusWidth:i.right+n.outerWidth()})),this.model.set({offset:i})},ready:function(){var t,e;t=this.model.revisions.length-1,e=1/t,this.$el.css("width",50*this.model.revisions.length+"px"),_(t).times(function(t){this.$el.append('<div style="'+this.direction+": "+100*e*t+'%"></div>')},this)}}),e.view.Metabox=wp.Backbone.View.extend({className:"revisions-meta",initialize:function(){this.views.add(new e.view.MetaFrom({model:this.model,className:"diff-meta diff-meta-from"})),this.views.add(new e.view.MetaTo({model:this.model}))}}),e.view.Meta=wp.Backbone.View.extend({template:wp.template("revisions-meta"),events:{"click .restore-revision":"restoreRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.render)},prepare:function(){return _.extend(this.model.toJSON()[this.type]||{},{type:this.type})},restoreRevision:function(){document.location=this.model.get("to").attributes.restoreUrl}}),e.view.MetaFrom=e.view.Meta.extend({className:"diff-meta diff-meta-from",type:"from"}),e.view.MetaTo=e.view.Meta.extend({className:"diff-meta diff-meta-to",type:"to"}),e.view.Checkbox=wp.Backbone.View.extend({className:"revisions-checkbox",template:wp.template("revisions-checkbox"),events:{"click .compare-two-revisions":"compareTwoToggle"},initialize:function(){this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode)},ready:function(){this.model.revisions.length<3&&t(".revision-toggle-compare-mode").hide()},updateCompareTwoMode:function(){this.$(".compare-two-revisions").prop("checked",this.model.get("compareTwoMode"))},compareTwoToggle:function(){this.model.set({compareTwoMode:t(".compare-two-revisions").prop("checked")})}}),e.view.Tooltip=wp.Backbone.View.extend({className:"revisions-tooltip",template:wp.template("revisions-meta"),initialize:function(){this.listenTo(this.model,"change:offset",this.render),this.listenTo(this.model,"change:hovering",this.toggleVisibility),this.listenTo(this.model,"change:scrubbing",this.toggleVisibility)},prepare:function(){return _.isNull(this.model.get("revision"))?void 0:_.extend({type:"tooltip"},{attributes:this.model.get("revision").toJSON()})},render:function(){var t,e,i,s,r={};s=(this.model.revisions.indexOf(this.model.get("revision"))+1)/this.model.revisions.length>.5,isRtl?(e=s?"left":"right",i=s?"leftPlusWidth":e):(e=s?"right":"left",i=s?"rightPlusWidth":e),t="right"===e?"left":"right",wp.Backbone.View.prototype.render.apply(this,arguments),r[e]=this.model.get("offset")[i]+"px",r[t]="",this.$el.toggleClass("flipped",s).css(r)},visible:function(){return this.model.get("scrubbing")||this.model.get("hovering")},toggleVisibility:function(){this.visible()?this.$el.stop().show().fadeTo(100-100*this.el.style.opacity,1):this.$el.stop().fadeTo(300*this.el.style.opacity,0,function(){t(this).hide()})}}),e.view.Buttons=wp.Backbone.View.extend({className:"revisions-buttons",template:wp.template("revisions-buttons"),events:{"click .revisions-next .button":"nextRevision","click .revisions-previous .button":"previousRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.disabledButtonCheck)},ready:function(){this.disabledButtonCheck()},gotoModel:function(t){var e={to:this.model.revisions.at(t)};t?e.from=this.model.revisions.at(t-1):this.model.unset("from",{silent:!0}),this.model.set(e)},nextRevision:function(){var t=this.model.revisions.indexOf(this.model.get("to"))+1;this.gotoModel(t)},previousRevision:function(){var t=this.model.revisions.indexOf(this.model.get("to"))-1;this.gotoModel(t)},disabledButtonCheck:function(){var e=this.model.revisions.length-1,i=t(".revisions-next .button"),s=t(".revisions-previous .button"),r=this.model.revisions.indexOf(this.model.get("to"));i.prop("disabled",e===r),s.prop("disabled",0===r)}}),e.view.Slider=wp.Backbone.View.extend({className:"wp-slider",direction:isRtl?"right":"left",events:{mousemove:"mouseMove"},initialize:function(){_.bindAll(this,"start","slide","stop","mouseMove","mouseEnter","mouseLeave"),this.listenTo(this.model,"update:slider",this.applySliderSettings)},ready:function(){this.$el.css("width",50*this.model.revisions.length+"px"),this.$el.slider(_.extend(this.model.toJSON(),{start:this.start,slide:this.slide,stop:this.stop})),this.$el.hoverIntent({over:this.mouseEnter,out:this.mouseLeave,timeout:800}),this.applySliderSettings()},mouseMove:function(e){var i=this.model.revisions.length-1,s=this.$el.allOffsets()[this.direction],r=this.$el.width(),n=r/i,a=(isRtl?t(window).width()-e.pageX:e.pageX)-s,o=Math.floor((a+n/2)/n);o<0?o=0:o>=this.model.revisions.length&&(o=this.model.revisions.length-1),this.model.set({hoveredRevision:this.model.revisions.at(o)})},mouseLeave:function(){this.model.set({hovering:!1})},mouseEnter:function(){this.model.set({hovering:!0})},applySliderSettings:function(){this.$el.slider(_.pick(this.model.toJSON(),"value","values","range"));var t=this.$("a.ui-slider-handle");this.model.get("compareTwoMode")?(t.first().toggleClass("to-handle",!!isRtl).toggleClass("from-handle",!isRtl),t.last().toggleClass("from-handle",!!isRtl).toggleClass("to-handle",!isRtl)):t.removeClass("from-handle to-handle")},start:function(e,i){this.model.set({scrubbing:!0}),t(window).on("mousemove.wp.revisions",{view:this},function(e){var s,r=e.data.view,n=r.$el.offset().left,a=n,o=n+r.$el.width(),h=o,d="0",c="100%",l=t(i.handle);r.model.get("compareTwoMode")&&(s=l.parent().find(".ui-slider-handle"),l.is(s.first())?(h=s.last().offset().left,c=h-a):(n=s.first().offset().left+s.first().width(),d=n-a)),e.pageX<n?l.css("left",d):e.pageX>h?l.css("left",c):l.css("left",e.pageX-a)})},getPosition:function(t){return isRtl?this.model.revisions.length-t-1:t},slide:function(t,e){var i,s;if(this.model.get("compareTwoMode")){if(e.values[1]===e.values[0])return!1;isRtl&&e.values.reverse(),i={from:this.model.revisions.at(this.getPosition(e.values[0])),to:this.model.revisions.at(this.getPosition(e.values[1]))}}else i={to:this.model.revisions.at(this.getPosition(e.value))},this.getPosition(e.value)>0?i.from=this.model.revisions.at(this.getPosition(e.value)-1):i.from=undefined;s=this.model.revisions.at(this.getPosition(e.value)),this.model.get("scrubbing")&&(i.hoveredRevision=s),this.model.set(i)},stop:function(){t(window).off("mousemove.wp.revisions"),this.model.updateSliderSettings(),this.model.set({scrubbing:!1})}}),e.view.Diff=wp.Backbone.View.extend({className:"revisions-diff",template:wp.template("revisions-diff"),prepare:function(){return _.extend({fields:this.model.fields.toJSON()},this.options)}}),e.Router=Backbone.Router.extend({initialize:function(t){this.model=t.model,this.listenTo(this.model,"update:diff",_.debounce(this.updateUrl,250)),this.listenTo(this.model,"change:compareTwoMode",this.updateUrl)},baseUrl:function(t){return this.model.get("baseUrl")+t},updateUrl:function(){var t=this.model.has("from")?this.model.get("from").id:0,e=this.model.get("to").id;this.model.get("compareTwoMode")?this.navigate(this.baseUrl("?from="+t+"&to="+e),{replace:!0}):this.navigate(this.baseUrl("?revision="+e),{replace:!0})},handleRoute:function(t,e){_.isUndefined(e)||(e=this.model.revisions.get(t),t=this.model.revisions.prev(e),e=e?e.id:0,t=t?t.id:0)}}),e.init=function(){var t;window.adminpage&&"revision-php"===window.adminpage&&(t=new e.model.FrameState({initialDiffState:{to:parseInt(e.settings.to,10),from:parseInt(e.settings.from,10),compareTwoMode:"1"===e.settings.compareTwoMode},diffData:e.settings.diffData,baseUrl:e.settings.baseUrl,postId:parseInt(e.settings.postId,10)},{revisions:new e.model.Revisions(e.settings.revisionData)}),e.view.frame=new e.view.Frame({model:t}).render())},t(e.init)}(jQuery);