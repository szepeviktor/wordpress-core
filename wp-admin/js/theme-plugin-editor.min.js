window.wp||(window.wp={}),wp.themePluginEditor=function(t){"use strict";var e,i;e={l10n:{lintError:{singular:"",plural:""},saveAlert:"",saveError:""},codeEditor:{},instance:null,noticeElements:{},dirty:!1,lintErrors:[]},e.init=function(i,s){e.form=i,s&&t.extend(e,s),e.noticeTemplate=wp.template("wp-file-editor-notice"),e.noticesContainer=e.form.find(".editor-notices"),e.submitButton=e.form.find(":input[name=submit]"),e.spinner=e.form.find(".submit .spinner"),e.form.on("submit",e.submit),e.textarea=e.form.find("#newcontent"),e.textarea.on("change",e.onChange),e.warning=t(".file-editor-warning"),e.warning.length>0&&e.showWarning(),!1!==e.codeEditor&&_.defer(function(){e.initCodeEditor()}),t(e.initFileBrowser),t(window).on("beforeunload",function(){return e.dirty?e.l10n.saveAlert:undefined})},e.showWarning=function(){var i=e.warning.find(".file-editor-warning-message").text();t("#wpwrap").attr("aria-hidden","true"),t(document.body).addClass("modal-open").append(e.warning.detach()),e.warning.removeClass("hidden").find(".file-editor-warning-go-back").focus(),e.warningTabbables=e.warning.find("a, button"),e.warningTabbables.on("keydown",e.constrainTabbing),e.warning.on("click",".file-editor-warning-dismiss",e.dismissWarning),setTimeout(function(){wp.a11y.speak(wp.sanitize.stripTags(i.replace(/\s+/g," ")),"assertive")},1e3)},e.constrainTabbing=function(t){var i,s;9===t.which&&(i=e.warningTabbables.first()[0],s=e.warningTabbables.last()[0],s!==t.target||t.shiftKey?i===t.target&&t.shiftKey&&(s.focus(),t.preventDefault()):(i.focus(),t.preventDefault()))},e.dismissWarning=function(){wp.ajax.post("dismiss-wp-pointer",{pointer:e.themeOrPlugin+"_editor_notice"}),e.warning.remove(),t("#wpwrap").removeAttr("aria-hidden"),t("body").removeClass("modal-open")},e.onChange=function(){e.dirty=!0,e.removeNotice("file_saved")},e.submit=function(i){var s,r={};if(i.preventDefault(),t.each(e.form.serializeArray(),function(){r[this.name]=this.value}),e.instance&&(r.newcontent=e.instance.codemirror.getValue()),!e.isSaving){if(e.lintErrors.length)return void e.instance.codemirror.setCursor(e.lintErrors[0].from.line);e.isSaving=!0,e.textarea.prop("readonly",!0),e.instance&&e.instance.codemirror.setOption("readOnly",!0),e.spinner.addClass("is-active"),s=wp.ajax.post("edit-theme-plugin-file",r),e.lastSaveNoticeCode&&e.removeNotice(e.lastSaveNoticeCode),s.done(function(t){e.lastSaveNoticeCode="file_saved",e.addNotice({code:e.lastSaveNoticeCode,type:"success",message:t.message,dismissible:!0}),e.dirty=!1}),s.fail(function(i){var s=t.extend({code:"save_error",message:e.l10n.saveError},i,{type:"error",dismissible:!0});e.lastSaveNoticeCode=s.code,e.addNotice(s)}),s.always(function(){e.spinner.removeClass("is-active"),e.isSaving=!1,e.textarea.prop("readonly",!1),e.instance&&e.instance.codemirror.setOption("readOnly",!1)})}},e.addNotice=function(i){var s;if(!i.code)throw new Error("Missing code.");return e.removeNotice(i.code),s=t(e.noticeTemplate(i)),s.hide(),s.find(".notice-dismiss").on("click",function(){e.removeNotice(i.code),i.onDismiss&&i.onDismiss(i)}),wp.a11y.speak(i.message),e.noticesContainer.append(s),s.slideDown("fast"),e.noticeElements[i.code]=s,s},e.removeNotice=function(i){return!!e.noticeElements[i]&&(e.noticeElements[i].slideUp("fast",function(){t(this).remove()}),delete e.noticeElements[i],!0)},e.initCodeEditor=function(){var i,s;i=t.extend({},e.codeEditor),i.onTabPrevious=function(){t("#templateside").find(":tabbable").last().focus()},i.onTabNext=function(){t("#template").find(":tabbable:not(.CodeMirror-code)").first().focus()},i.onChangeLintingErrors=function(t){e.lintErrors=t,0===t.length&&e.submitButton.toggleClass("disabled",!1)},i.onUpdateErrorNotice=function(t){var s,r;e.submitButton.toggleClass("disabled",t.length>0),0!==t.length?(s=1===t.length?e.l10n.lintError.singular.replace("%d","1"):e.l10n.lintError.plural.replace("%d",String(t.length)),r=e.addNotice({code:"lint_errors",type:"error",message:s,dismissible:!1}),r.find("input[type=checkbox]").on("click",function(){i.onChangeLintingErrors([]),e.removeNotice("lint_errors")})):e.removeNotice("lint_errors")},s=wp.codeEditor.initialize(t("#newcontent"),i),s.codemirror.on("change",e.onChange),t(s.codemirror.display.lineDiv).attr({role:"textbox","aria-multiline":"true","aria-labelledby":"theme-plugin-editor-label","aria-describedby":"editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4"}),t("#theme-plugin-editor-label").on("click",function(){s.codemirror.focus()}),e.instance=s},e.initFileBrowser=function(){var e=t("#templateside");e.find('[role="group"]').parent().attr("aria-expanded",!1),e.find(".notice").parents("[aria-expanded]").attr("aria-expanded",!0),e.find('[role="tree"]').each(function(){new i(this).init()}),e.find(".current-file:first").each(function(){this.scrollIntoViewIfNeeded?this.scrollIntoViewIfNeeded():this.scrollIntoView(!1)})};var s=function(){var t=function(t,e,i){if("object"==typeof t){t.tabIndex=-1,this.tree=e,this.groupTreeitem=i,this.domNode=t,this.label=t.textContent.trim(),this.stopDefaultClick=!1,t.getAttribute("aria-label")&&(this.label=t.getAttribute("aria-label").trim()),this.isExpandable=!1,this.isVisible=!1,this.inGroup=!1,i&&(this.inGroup=!0);for(var s=t.firstElementChild;s;){if("ul"==s.tagName.toLowerCase()){s.setAttribute("role","group"),this.isExpandable=!0;break}s=s.nextElementSibling}this.keyCode=Object.freeze({RETURN:13,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40})}};return t.prototype.init=function(){this.domNode.tabIndex=-1,this.domNode.getAttribute("role")||this.domNode.setAttribute("role","treeitem"),this.domNode.addEventListener("keydown",this.handleKeydown.bind(this)),this.domNode.addEventListener("click",this.handleClick.bind(this)),this.domNode.addEventListener("focus",this.handleFocus.bind(this)),this.domNode.addEventListener("blur",this.handleBlur.bind(this)),this.isExpandable?(this.domNode.firstElementChild.addEventListener("mouseover",this.handleMouseOver.bind(this)),this.domNode.firstElementChild.addEventListener("mouseout",this.handleMouseOut.bind(this))):(this.domNode.addEventListener("mouseover",this.handleMouseOver.bind(this)),this.domNode.addEventListener("mouseout",this.handleMouseOut.bind(this)))},t.prototype.isExpanded=function(){return!!this.isExpandable&&"true"===this.domNode.getAttribute("aria-expanded")},t.prototype.handleKeydown=function(t){function e(t){return 1===t.length&&t.match(/\S/)}function i(t){"*"==r?(t.tree.expandAllSiblingItems(t),s=!0):e(r)&&(t.tree.setFocusByFirstCharacter(t,r),s=!0)}var s=(t.currentTarget,!1),r=t.key;if(this.stopDefaultClick=!1,!(t.altKey||t.ctrlKey||t.metaKey)){if(t.shift)t.keyCode==this.keyCode.SPACE||t.keyCode==this.keyCode.RETURN?(t.stopPropagation(),this.stopDefaultClick=!0):e(r)&&i(this);else switch(t.keyCode){case this.keyCode.SPACE:case this.keyCode.RETURN:this.isExpandable?(this.isExpanded()?this.tree.collapseTreeitem(this):this.tree.expandTreeitem(this),s=!0):(t.stopPropagation(),this.stopDefaultClick=!0);break;case this.keyCode.UP:this.tree.setFocusToPreviousItem(this),s=!0;break;case this.keyCode.DOWN:this.tree.setFocusToNextItem(this),s=!0;break;case this.keyCode.RIGHT:this.isExpandable&&(this.isExpanded()?this.tree.setFocusToNextItem(this):this.tree.expandTreeitem(this)),s=!0;break;case this.keyCode.LEFT:this.isExpandable&&this.isExpanded()?(this.tree.collapseTreeitem(this),s=!0):this.inGroup&&(this.tree.setFocusToParentItem(this),s=!0);break;case this.keyCode.HOME:this.tree.setFocusToFirstItem(),s=!0;break;case this.keyCode.END:this.tree.setFocusToLastItem(),s=!0;break;default:e(r)&&i(this)}s&&(t.stopPropagation(),t.preventDefault())}},t.prototype.handleClick=function(t){t.target!==this.domNode&&t.target!==this.domNode.firstElementChild||this.isExpandable&&(this.isExpanded()?this.tree.collapseTreeitem(this):this.tree.expandTreeitem(this),t.stopPropagation())},t.prototype.handleFocus=function(t){var e=this.domNode;this.isExpandable&&(e=e.firstElementChild),e.classList.add("focus")},t.prototype.handleBlur=function(t){var e=this.domNode;this.isExpandable&&(e=e.firstElementChild),e.classList.remove("focus")},t.prototype.handleMouseOver=function(t){t.currentTarget.classList.add("hover")},t.prototype.handleMouseOut=function(t){t.currentTarget.classList.remove("hover")},t}();return i=function(){var t=function(t){"object"==typeof t&&(this.domNode=t,this.treeitems=[],this.firstChars=[],this.firstTreeitem=null,this.lastTreeitem=null)};return t.prototype.init=function(){function t(e,i,r){for(var n=e.firstElementChild,a=r;n;)("li"===n.tagName.toLowerCase()&&"span"===n.firstElementChild.tagName.toLowerCase()||"a"===n.tagName.toLowerCase())&&(a=new s(n,i,r),a.init(),i.treeitems.push(a),i.firstChars.push(a.label.substring(0,1).toLowerCase())),n.firstElementChild&&t(n,i,a),n=n.nextElementSibling}this.domNode.getAttribute("role")||this.domNode.setAttribute("role","tree"),t(this.domNode,this,!1),this.updateVisibleTreeitems(),this.firstTreeitem.domNode.tabIndex=0},t.prototype.setFocusToItem=function(t){for(var e=0;e<this.treeitems.length;e++){var i=this.treeitems[e];i===t?(i.domNode.tabIndex=0,i.domNode.focus()):i.domNode.tabIndex=-1}},t.prototype.setFocusToNextItem=function(t){for(var e=!1,i=this.treeitems.length-1;i>=0;i--){var s=this.treeitems[i];if(s===t)break;s.isVisible&&(e=s)}e&&this.setFocusToItem(e)},t.prototype.setFocusToPreviousItem=function(t){for(var e=!1,i=0;i<this.treeitems.length;i++){var s=this.treeitems[i];if(s===t)break;s.isVisible&&(e=s)}e&&this.setFocusToItem(e)},t.prototype.setFocusToParentItem=function(t){t.groupTreeitem&&this.setFocusToItem(t.groupTreeitem)},t.prototype.setFocusToFirstItem=function(){this.setFocusToItem(this.firstTreeitem)},t.prototype.setFocusToLastItem=function(){this.setFocusToItem(this.lastTreeitem)},t.prototype.expandTreeitem=function(t){t.isExpandable&&(t.domNode.setAttribute("aria-expanded",!0),this.updateVisibleTreeitems())},t.prototype.expandAllSiblingItems=function(t){for(var e=0;e<this.treeitems.length;e++){var i=this.treeitems[e];i.groupTreeitem===t.groupTreeitem&&i.isExpandable&&this.expandTreeitem(i)}},t.prototype.collapseTreeitem=function(t){var e=!1;(e=t.isExpanded()?t:t.groupTreeitem)&&(e.domNode.setAttribute("aria-expanded",!1),this.updateVisibleTreeitems(),this.setFocusToItem(e))},t.prototype.updateVisibleTreeitems=function(){this.firstTreeitem=this.treeitems[0];for(var t=0;t<this.treeitems.length;t++){var e=this.treeitems[t],i=e.domNode.parentNode;for(e.isVisible=!0;i&&i!==this.domNode;)"false"==i.getAttribute("aria-expanded")&&(e.isVisible=!1),i=i.parentNode;e.isVisible&&(this.lastTreeitem=e)}},t.prototype.setFocusByFirstCharacter=function(t,e){var i,s;e=e.toLowerCase(),i=this.treeitems.indexOf(t)+1,i===this.treeitems.length&&(i=0),s=this.getIndexFirstChars(i,e),-1===s&&(s=this.getIndexFirstChars(0,e)),s>-1&&this.setFocusToItem(this.treeitems[s])},t.prototype.getIndexFirstChars=function(t,e){for(var i=t;i<this.firstChars.length;i++)if(this.treeitems[i].isVisible&&e===this.firstChars[i])return i;return-1},t}(),e}(jQuery);