wp.mediaWidgets=function(t){"use strict";var e={};return e.controlConstructors={},e.modelConstructors={},e.PersistentDisplaySettingsLibrary=wp.media.controller.Library.extend({initialize:function(t){_.bindAll(this,"handleDisplaySettingChange"),wp.media.controller.Library.prototype.initialize.call(this,t)},handleDisplaySettingChange:function(t){this.get("selectedDisplaySettings").set(t.attributes)},display:function(t){var e,i=this.get("selectedDisplaySettings");return e=wp.media.controller.Library.prototype.display.call(this,t),e.off("change",this.handleDisplaySettingChange),e.set(i.attributes),"custom"===i.get("link_type")&&(e.linkUrl=i.get("link_url")),e.on("change",this.handleDisplaySettingChange),e}}),e.MediaEmbedView=wp.media.view.Embed.extend({initialize:function(t){var e,i=this;wp.media.view.Embed.prototype.initialize.call(i,t),"image"!==i.controller.options.mimeType&&(e=i.controller.states.get("embed"),e.off("scan",e.scanImage,e))},refresh:function(){var e;e="image"===this.controller.options.mimeType?wp.media.view.EmbedImage:wp.media.view.EmbedLink.extend({setAddToWidgetButtonDisabled:function(t){this.views.parent.views.parent.views.get(".media-frame-toolbar")[0].$el.find(".media-button-select").prop("disabled",t)},setErrorNotice:function(e){var i,s=this;i=s.views.parent.$el.find("> .notice:first-child"),e?(i.length||(i=t('<div class="media-widget-embed-notice notice notice-error notice-alt"></div>'),i.hide(),s.views.parent.$el.prepend(i)),i.empty(),i.append(t("<p>",{html:e})),i.slideDown("fast")):i.length&&i.slideUp("fast")},updateoEmbed:function(){var t,e=this;if(!(t=e.model.get("url")))return e.setErrorNotice(""),void e.setAddToWidgetButtonDisabled(!0);t.match(/^(http|https):\/\/.+\//)||(e.controller.$el.find("#embed-url-field").addClass("invalid"),e.setAddToWidgetButtonDisabled(!0)),wp.media.view.EmbedLink.prototype.updateoEmbed.call(e)},fetch:function(){var t,e,i,s,r,n,a,o=this;if(r=o.model.get("url"),o.dfd&&"pending"===o.dfd.state()&&o.dfd.abort(),t=function(t){o.renderoEmbed({data:{body:t}}),o.controller.$el.find("#embed-url-field").removeClass("invalid"),o.setErrorNotice(""),o.setAddToWidgetButtonDisabled(!1)},s=document.createElement("a"),s.href=r,e=s.pathname.toLowerCase().match(/\.(\w+)$/))return i=e[1],void(wp.media.view.settings.embedMimes[i]?0!==wp.media.view.settings.embedMimes[i].indexOf(o.controller.options.mimeType)?o.renderFail():t("\x3c!--success--\x3e"):o.renderFail());n=/https?:\/\/www\.youtube\.com\/embed\/([^\/]+)/,a=n.exec(r),a&&(r="https://www.youtube.com/watch?v="+a[1],o.model.attributes.url=r),o.dfd=wp.apiRequest({url:wp.media.view.settings.oEmbedProxyUrl,data:{url:r,maxwidth:o.model.get("width"),maxheight:o.model.get("height"),discover:!1},type:"GET",dataType:"json",context:o}),o.dfd.done(function(e){if(o.controller.options.mimeType!==e.type)return void o.renderFail();t(e.html)}),o.dfd.fail(_.bind(o.renderFail,o))},renderFail:function(){var t=this;t.controller.$el.find("#embed-url-field").addClass("invalid"),t.setErrorNotice(t.controller.options.invalidEmbedTypeError||"ERROR"),t.setAddToWidgetButtonDisabled(!0)}}),this.settings(new e({controller:this.controller,model:this.model.props,priority:40}))}}),e.MediaFrameSelect=wp.media.view.MediaFrame.Post.extend({createStates:function(){var t=this.options.mimeType,i=[];_.each(wp.media.view.settings.embedMimes,function(e){0===e.indexOf(t)&&i.push(e)}),i.length>0&&(t=i),this.states.add([new e.PersistentDisplaySettingsLibrary({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:"dates",library:wp.media.query({type:t}),multiple:!1,editable:!0,selectedDisplaySettings:this.options.selectedDisplaySettings,displaySettings:!!_.isUndefined(this.options.showDisplaySettings)||this.options.showDisplaySettings,displayUserSettings:!1}),new wp.media.controller.EditImage({model:this.options.editImage}),new wp.media.controller.Embed({metadata:this.options.metadata,type:"image"===this.options.mimeType?"image":"link",invalidEmbedTypeError:this.options.invalidEmbedTypeError})])},mainInsertToolbar:function(t){var e=this;t.set("insert",{style:"primary",priority:80,text:e.options.text,requires:{selection:!0},click:function(){var t=e.state(),i=t.get("selection");e.close(),t.trigger("insert",i).reset()}})},mainEmbedToolbar:function(t){t.view=new wp.media.view.Toolbar.Embed({controller:this,text:this.options.text,event:"insert"})},embedContent:function(){var t=new e.MediaEmbedView({controller:this,model:this.state()}).render();this.content.set(t),wp.media.isTouchDevice||t.url.focus()}}),e.MediaWidgetControl=Backbone.View.extend({l10n:{add_to_widget:"{{add_to_widget}}",add_media:"{{add_media}}"},id_base:"",mime_type:"",events:{"click .notice-missing-attachment a":"handleMediaLibraryLinkClick","click .select-media":"selectMedia","click .placeholder":"selectMedia","click .edit-media":"editMedia"},showDisplaySettings:!0,initialize:function(i){var s=this;if(Backbone.View.prototype.initialize.call(s,i),!(s.model instanceof e.MediaWidgetModel))throw new Error("Missing options.model");if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");if(s.syncContainer=i.syncContainer,s.$el.addClass("media-widget-control"),_.bindAll(s,"syncModelToInputs","render","updateSelectedAttachment","renderPreview"),!s.id_base&&(_.find(e.controlConstructors,function(t,e){return s instanceof t&&(s.id_base=e,!0)}),!s.id_base))throw new Error("Missing id_base.");s.previewTemplateProps=new Backbone.Model(s.mapModelToPreviewTemplateProps()),s.selectedAttachment=new wp.media.model.Attachment,s.renderPreview=_.debounce(s.renderPreview),s.listenTo(s.previewTemplateProps,"change",s.renderPreview),s.model.on("change:attachment_id",s.updateSelectedAttachment),s.model.on("change:url",s.updateSelectedAttachment),s.updateSelectedAttachment(),s.listenTo(s.model,"change",s.syncModelToInputs),s.listenTo(s.model,"change",s.syncModelToPreviewProps),s.listenTo(s.model,"change",s.render),s.$el.on("input change",".title",function(){s.model.set({title:t.trim(t(this).val())})}),s.$el.on("input change",".link",function(){var e=t.trim(t(this).val()),i="custom";s.selectedAttachment.get("linkUrl")===e||s.selectedAttachment.get("link")===e?i="post":s.selectedAttachment.get("url")===e&&(i="file"),s.model.set({link_url:e,link_type:i}),s.displaySettings.set({link:i,linkUrl:e})}),s.displaySettings=new Backbone.Model(_.pick(s.mapModelToMediaFrameProps(_.extend(s.model.defaults(),s.model.toJSON())),_.keys(wp.media.view.settings.defaultProps)))},updateSelectedAttachment:function(){var t,e=this;0===e.model.get("attachment_id")?(e.selectedAttachment.clear(),e.model.set("error",!1)):e.model.get("attachment_id")!==e.selectedAttachment.get("id")&&(t=new wp.media.model.Attachment({id:e.model.get("attachment_id")}),t.fetch().done(function(){e.model.set("error",!1),e.selectedAttachment.set(t.toJSON())}).fail(function(){e.model.set("error","missing_attachment")}))},syncModelToPreviewProps:function(){var t=this;t.previewTemplateProps.set(t.mapModelToPreviewTemplateProps())},syncModelToInputs:function(){var e=this;e.syncContainer.find(".media-widget-instance-property").each(function(){var i,s,r=t(this);s=r.data("property"),i=e.model.get(s),_.isUndefined(i)||(i="array"===e.model.schema[s].type&&_.isArray(i)?i.join(","):"boolean"===e.model.schema[s].type?i?"1":"":String(i),r.val()!==i&&(r.val(i),r.trigger("change")))})},template:function(){var e=this;if(!t("#tmpl-widget-media-"+e.id_base+"-control").length)throw new Error("Missing widget control template for "+e.id_base);return wp.template("widget-media-"+e.id_base+"-control")},render:function(){var t,e=this;e.templateRendered||(e.$el.html(e.template()(e.model.toJSON())),e.renderPreview(),e.templateRendered=!0),t=e.$el.find(".title"),t.is(document.activeElement)||t.val(e.model.get("title")),e.$el.toggleClass("selected",e.isSelected())},renderPreview:function(){throw new Error("renderPreview must be implemented")},isSelected:function(){var t=this;return!t.model.get("error")&&Boolean(t.model.get("attachment_id")||t.model.get("url"))},handleMediaLibraryLinkClick:function(t){var e=this;t.preventDefault(),e.selectMedia()},selectMedia:function(){var i,s,r,n,a=this,o=[];a.isSelected()&&0!==a.model.get("attachment_id")&&o.push(a.selectedAttachment),i=new wp.media.model.Selection(o,{multiple:!1}),n=a.mapModelToMediaFrameProps(a.model.toJSON()),n.size&&a.displaySettings.set("size",n.size),s=new e.MediaFrameSelect({title:a.l10n.add_media,frame:"post",text:a.l10n.add_to_widget,selection:i,mimeType:a.mime_type,selectedDisplaySettings:a.displaySettings,showDisplaySettings:a.showDisplaySettings,metadata:n,state:a.isSelected()&&0===a.model.get("attachment_id")?"embed":"insert",invalidEmbedTypeError:a.l10n.unsupported_file_type}),wp.media.frame=s,s.on("insert",function(){var t={},e=s.state();"embed"===e.get("id")?_.extend(t,{id:0},e.props.toJSON()):_.extend(t,e.get("selection").first().toJSON()),a.selectedAttachment.set(t),a.model.set("error",!1),a.model.set(a.getModelPropsFromMediaFrame(s))}),r=wp.media.model.Attachment.prototype.sync,wp.media.model.Attachment.prototype.sync=function(e){return"delete"===e?r.apply(this,arguments):t.Deferred().rejectWith(this).promise()},s.on("close",function(){wp.media.model.Attachment.prototype.sync=r}),s.$el.addClass("media-widget"),s.open(),i&&i.on("destroy",function(t){a.model.get("attachment_id")===t.get("id")&&a.model.set({attachment_id:0,url:""})}),s.$el.find(".media-frame-menu .media-menu-item.active").focus()},getModelPropsFromMediaFrame:function(t){var e,i,s,r=this;if(e=t.state(),"insert"===e.get("id"))i=e.get("selection").first().toJSON(),i.postUrl=i.link,r.showDisplaySettings&&_.extend(i,t.content.get(".attachments-browser").sidebar.get("display").model.toJSON()),i.sizes&&i.size&&i.sizes[i.size]&&(i.url=i.sizes[i.size].url);else{if("embed"!==e.get("id"))throw new Error("Unexpected state: "+e.get("id"));i=_.extend(e.props.toJSON(),{attachment_id:0},r.model.getEmbedResetProps())}return i.id&&(i.attachment_id=i.id),s=r.mapMediaToModelProps(i),_.each(wp.media.view.settings.embedExts,function(t){t in r.model.schema&&s.url!==s[t]&&(s[t]="")}),s},mapMediaToModelProps:function(t){var e,i=this,s={},r={};return _.each(i.model.schema,function(t,e){"title"!==e&&(s[t.media_prop||e]=e)}),_.each(t,function(t,e){var n=s[e]||e;i.model.schema[n]&&(r[n]=t)}),"custom"===t.size&&(r.width=t.customWidth,r.height=t.customHeight),"post"===t.link?r.link_url=t.postUrl||t.linkUrl:"file"===t.link&&(r.link_url=t.url),!t.attachment_id&&t.id&&(r.attachment_id=t.id),t.url&&(e=t.url.replace(/#.*$/,"").replace(/\?.*$/,"").split(".").pop().toLowerCase())in i.model.schema&&(r[e]=t.url),_.omit(r,"title")},mapModelToMediaFrameProps:function(t){var e=this,i={};return _.each(t,function(t,s){var r=e.model.schema[s]||{};i[r.media_prop||s]=t}),i.attachment_id=i.id,"custom"===i.size&&(i.customWidth=e.model.get("width"),i.customHeight=e.model.get("height")),i},mapModelToPreviewTemplateProps:function(){var t=this,e={};return _.each(t.model.schema,function(i,s){i.hasOwnProperty("should_preview_update")&&!i.should_preview_update||(e[s]=t.model.get(s))}),e.error=t.model.get("error"),e},editMedia:function(){throw new Error("editMedia not implemented")}}),e.MediaWidgetModel=Backbone.Model.extend({idAttribute:"widget_id",schema:{title:{type:"string","default":""},attachment_id:{type:"integer","default":0},url:{type:"string","default":""}},defaults:function(){var t={};return _.each(this.schema,function(e,i){t[i]=e["default"]}),t},set:function(t,e,i){var s,r,n,a=this;return null===t?a:("object"==typeof t?(s=t,r=e):(s={},s[t]=e,r=i),n={},_.each(s,function(t,e){var i;if(!a.schema[e])return void(n[e]=t);i=a.schema[e].type,"array"===i?(n[e]=t,_.isArray(n[e])||(n[e]=n[e].split(/,/)),a.schema[e].items&&"integer"===a.schema[e].items.type&&(n[e]=_.filter(_.map(n[e],function(t){return parseInt(t,10)},function(t){return"number"==typeof t})))):n[e]="integer"===i?parseInt(t,10):"boolean"===i?!(!t||"0"===t||"false"===t):t}),Backbone.Model.prototype.set.call(this,n,r))},getEmbedResetProps:function(){return{id:0}}}),e.modelCollection=new(Backbone.Collection.extend({model:e.MediaWidgetModel})),e.widgetControls={},e.handleWidgetAdded=function(i,s){var r,n,a,o,h,d,c,l,u,p,m;a=s.find("> .widget-inside > .form, > .widget-inside > form"),o=a.find("> .id_base").val(),p=a.find("> .widget-id").val(),e.widgetControls[p]||(h=e.controlConstructors[o])&&(d=e.modelConstructors[o]||e.MediaWidgetModel,r=t("<div></div>"),n=s.find(".widget-content:first"),n.before(r),c={},n.find(".media-widget-instance-property").each(function(){var e=t(this);c[e.data("property")]=e.val()}),c.widget_id=p,u=new d(c),l=new h({el:r,syncContainer:n,model:u}),m=function(){s.hasClass("open")?l.render():setTimeout(m,50)},m(),e.modelCollection.add([u]),e.widgetControls[u.get("widget_id")]=l)},e.setupAccessibleMode=function(){var i,s,r,n,a,o,h,d,c;i=t(".editwidget > form"),0!==i.length&&(r=i.find("> .widget-control-actions > .id_base").val(),(a=e.controlConstructors[r])&&(s=i.find("> .widget-control-actions > .widget-id").val(),o=e.modelConstructors[r]||e.MediaWidgetModel,d=t("<div></div>"),c=i.find("> .widget-inside"),c.before(d),h={},c.find(".media-widget-instance-property").each(function(){var e=t(this);h[e.data("property")]=e.val()}),h.widget_id=s,n=new a({el:d,syncContainer:c,model:new o(h)}),e.modelCollection.add([n.model]),e.widgetControls[n.model.get("widget_id")]=n,n.render()))},e.handleWidgetUpdated=function(i,s){var r,n,a,o,h={};r=s.find("> .widget-inside > .form, > .widget-inside > form"),a=r.find("> .widget-id").val(),(o=e.widgetControls[a])&&(n=r.find("> .widget-content"),n.find(".media-widget-instance-property").each(function(){var e=t(this).data("property");h[e]=t(this).val()}),o.stopListening(o.model,"change",o.syncModelToInputs),o.model.set(h),o.listenTo(o.model,"change",o.syncModelToInputs))},e.init=function(){var i=t(document);i.on("widget-added",e.handleWidgetAdded),i.on("widget-synced widget-updated",e.handleWidgetUpdated),t(function(){var i;"widgets"===window.pagenow&&(i=t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function(){var i=t(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),t(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);