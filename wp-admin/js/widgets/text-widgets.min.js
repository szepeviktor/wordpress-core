wp.textWidgets=function(t){"use strict";var e={dismissedPointers:[],idBases:["text"]};return e.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(e){var i=this;if(!e.el)throw new Error("Missing options.el");if(!e.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,e),i.syncContainer=e.syncContainer,i.$el.addClass("text-widget-fields"),i.$el.html(wp.template("widget-text-control-fields")),i.customHtmlWidgetPointer=i.$el.find(".wp-pointer.custom-html-widget-pointer"),i.customHtmlWidgetPointer.length&&(i.customHtmlWidgetPointer.find(".close").on("click",function(e){e.preventDefault(),i.customHtmlWidgetPointer.hide(),t("#"+i.fields.text.attr("id")+"-html").focus(),i.dismissPointers(["text_widget_custom_html"])}),i.customHtmlWidgetPointer.find(".add-widget").on("click",function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),i.openAvailableWidgetsPanel()})),i.pasteHtmlPointer=i.$el.find(".wp-pointer.paste-html-pointer"),i.pasteHtmlPointer.length&&i.pasteHtmlPointer.find(".close").on("click",function(t){t.preventDefault(),i.pasteHtmlPointer.hide(),i.editor.focus(),i.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])}),i.fields={title:i.$el.find(".title"),text:i.$el.find(".text")},_.each(i.fields,function(t,e){t.on("input change",function(){var s=i.syncContainer.find(".sync-input."+e);s.val()!==t.val()&&(s.val(t.val()),s.trigger("change"))}),t.val(i.syncContainer.find(".sync-input."+e).val())})},dismissPointers:function(t){_.each(t,function(t){wp.ajax.post("dismiss-wp-pointer",{pointer:t}),e.dismissedPointers.push(t)})},openAvailableWidgetsPanel:function(){var t;wp.customize.section.each(function(e){e.extended(wp.customize.Widgets.SidebarSection)&&e.expanded()&&(t=wp.customize.control("sidebars_widgets["+e.params.sidebarId+"]"))}),t&&setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(t),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function(){var t,e=this;e.fields.title.is(document.activeElement)||(t=e.syncContainer.find(".sync-input.title"),e.fields.title.val(t.val())),t=e.syncContainer.find(".sync-input.text"),e.fields.text.is(":visible")?e.fields.text.is(document.activeElement)||e.fields.text.val(t.val()):e.editor&&!e.editorFocused&&t.val()!==e.fields.text.val()&&e.editor.setContent(wp.editor.autop(t.val()))},initializeEditor:function(){function i(){var r,a,l;if(document.getElementById(s)){if("undefined"==typeof window.tinymce)return void wp.editor.initialize(s,{quicktags:!0,mediaButtons:!0});if(tinymce.get(s)&&(d=tinymce.get(s).isHidden(),wp.editor.remove(s)),t(document).one("wp-before-tinymce-init.text-widget-init",function(t,e){e.plugins&&(/\bwpview\b/.test(e.plugins)||(e.plugins+=",wpview"))}),wp.editor.initialize(s,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),l=function(e){e.show(),e.find(".close").focus(),wp.a11y.speak(e.find("h3, p").map(function(){return t(this).text()}).get().join("\n\n"))},!(r=window.tinymce.get(s)))throw new Error("Failed to initialize editor");a=function(){t(r.getWin()).on("unload",function(){_.defer(i)}),d&&switchEditors.go(s,"html"),t("#"+s+"-html").on("click",function(){o.pasteHtmlPointer.hide(),-1===e.dismissedPointers.indexOf("text_widget_custom_html")&&l(o.customHtmlWidgetPointer)}),t("#"+s+"-tmce").on("click",function(){o.customHtmlWidgetPointer.hide()}),r.on("pastepreprocess",function(t){var i=t.content;-1===e.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay(function(){l(o.pasteHtmlPointer)},250)})},r.initialized?a():r.on("init",a),o.editorFocused=!1,r.on("focus",function(){o.editorFocused=!0}),r.on("paste",function(){r.setDirty(!0),n()}),r.on("NodeChange",function(){c=!0}),r.on("NodeChange",_.debounce(n,h)),r.on("blur hide",function(){o.editorFocused=!1,n()}),o.editor=r}}var s,r,n,a,o=this,h=1e3,d=!1,c=!1;r=o.fields.text,s=r.attr("id"),a=r.val(),n=function(){o.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),o.editor.isHidden()||o.editor.save()),c&&a!==r.val()&&(r.trigger("change"),c=!1,a=r.val())},o.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function(){n()}),i()}}),e.widgetControls={},e.handleWidgetAdded=function(i,s){var r,n,a,o,h,d,c;r=s.find("> .widget-inside > .form, > .widget-inside > form"),n=r.find("> .id_base").val(),-1!==e.idBases.indexOf(n)&&(o=r.find(".widget-id").val(),e.widgetControls[o]||r.find(".visual").val()&&(d=t("<div></div>"),c=s.find(".widget-content:first"),c.before(d),a=new e.TextWidgetControl({el:d,syncContainer:c}),e.widgetControls[o]=a,(h=function(){s.hasClass("open")?a.initializeEditor():setTimeout(h,50)})()))},e.setupAccessibleMode=function(){var i,s,r,n,a;i=t(".editwidget > form"),0!==i.length&&(s=i.find("> .widget-control-actions > .id_base").val(),-1!==e.idBases.indexOf(s)&&i.find(".visual").val()&&(n=t("<div></div>"),a=i.find("> .widget-inside"),a.before(n),r=new e.TextWidgetControl({el:n,syncContainer:a}),r.initializeEditor()))},e.handleWidgetUpdated=function(t,i){var s,r,n,a;s=i.find("> .widget-inside > .form, > .widget-inside > form"),a=s.find("> .id_base").val(),-1!==e.idBases.indexOf(a)&&(r=s.find("> .widget-id").val(),(n=e.widgetControls[r])&&n.updateFields())},e.init=function(){var i=t(document);i.on("widget-added",e.handleWidgetAdded),i.on("widget-synced widget-updated",e.handleWidgetUpdated),t(function(){var i;"widgets"===window.pagenow&&(i=t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function(){var i=t(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),t(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);