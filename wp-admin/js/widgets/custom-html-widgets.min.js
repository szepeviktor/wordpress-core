wp.customHtmlWidgets=function(t){"use strict";var e={idBases:["custom_html"],codeEditorSettings:{},l10n:{errorNotice:{singular:"",plural:""}}};return e.CustomHtmlWidgetControl=Backbone.View.extend({events:{},initialize:function(t){var i=this;if(!t.el)throw new Error("Missing options.el");if(!t.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,t),i.syncContainer=t.syncContainer,i.widgetIdBase=i.syncContainer.parent().find(".id_base").val(),i.widgetNumber=i.syncContainer.parent().find(".widget_number").val(),i.customizeSettingId="widget_"+i.widgetIdBase+"["+String(i.widgetNumber)+"]",i.$el.addClass("custom-html-widget-fields"),i.$el.html(wp.template("widget-custom-html-control-fields")({codeEditorDisabled:e.codeEditorSettings.disabled})),i.errorNoticeContainer=i.$el.find(".code-editor-error-container"),i.currentErrorAnnotations=[],i.saveButton=i.syncContainer.add(i.syncContainer.parent().find(".widget-control-actions")).find(".widget-control-save, #savewidget"),i.saveButton.addClass("custom-html-widget-save-button"),i.fields={title:i.$el.find(".title"),content:i.$el.find(".content")},_.each(i.fields,function(t,e){t.on("input change",function(){var s=i.syncContainer.find(".sync-input."+e);s.val()!==t.val()&&(s.val(t.val()),s.trigger("change"))}),t.val(i.syncContainer.find(".sync-input."+e).val())})},updateFields:function(){var t,e=this;e.fields.title.is(document.activeElement)||(t=e.syncContainer.find(".sync-input.title"),e.fields.title.val(t.val())),e.contentUpdateBypassed=e.fields.content.is(document.activeElement)||e.editor&&e.editor.codemirror.state.focused||0!==e.currentErrorAnnotations,e.contentUpdateBypassed||(t=e.syncContainer.find(".sync-input.content"),e.fields.content.val(t.val()).trigger("change"))},updateErrorNotice:function(i){var s,r,n=this,a="";1===i.length?a=e.l10n.errorNotice.singular.replace("%d","1"):i.length>1&&(a=e.l10n.errorNotice.plural.replace("%d",String(i.length))),n.fields.content[0].setCustomValidity&&n.fields.content[0].setCustomValidity(a),wp.customize&&wp.customize.has(n.customizeSettingId)?(r=wp.customize(n.customizeSettingId),r.notifications.remove("htmlhint_error"),0!==i.length&&r.notifications.add("htmlhint_error",new wp.customize.Notification("htmlhint_error",{message:a,type:"error"}))):0!==i.length?(s=t('<div class="inline notice notice-error notice-alt"></div>'),s.append(t("<p></p>",{text:a})),n.errorNoticeContainer.empty(),n.errorNoticeContainer.append(s),n.errorNoticeContainer.slideDown("fast"),wp.a11y.speak(a)):n.errorNoticeContainer.slideUp("fast")},initializeEditor:function(){var i,s=this;e.codeEditorSettings.disabled||(i=_.extend({},e.codeEditorSettings,{onTabPrevious:function(){s.fields.title.focus()},onTabNext:function(){s.syncContainer.add(s.syncContainer.parent().find(".widget-position, .widget-control-actions")).find(":tabbable").first().focus()},onChangeLintingErrors:function(t){s.currentErrorAnnotations=t},onUpdateErrorNotice:function(t){s.saveButton.toggleClass("validation-blocked disabled",t.length>0),s.updateErrorNotice(t)}}),s.editor=wp.codeEditor.initialize(s.fields.content,i),t(s.editor.codemirror.display.lineDiv).attr({role:"textbox","aria-multiline":"true","aria-labelledby":s.fields.content[0].id+"-label","aria-describedby":"editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4"}),t("#"+s.fields.content[0].id+"-label").on("click",function(){s.editor.codemirror.focus()}),s.fields.content.on("change",function(){this.value!==s.editor.codemirror.getValue()&&s.editor.codemirror.setValue(this.value)}),s.editor.codemirror.on("change",function(){var t=s.editor.codemirror.getValue();t!==s.fields.content.val()&&s.fields.content.val(t).trigger("change")}),s.editor.codemirror.on("blur",function(){s.contentUpdateBypassed&&s.syncContainer.find(".sync-input.content").trigger("change")}),wp.customize&&s.editor.codemirror.on("keydown",function(t,e){27===e.keyCode&&e.stopPropagation()}))}}),e.widgetControls={},e.handleWidgetAdded=function(i,s){var r,n,a,o,h,d,c;r=s.find("> .widget-inside > .form, > .widget-inside > form"),n=r.find("> .id_base").val(),-1!==e.idBases.indexOf(n)&&(o=r.find(".widget-id").val(),e.widgetControls[o]||(d=t("<div></div>"),c=s.find(".widget-content:first"),c.before(d),a=new e.CustomHtmlWidgetControl({el:d,syncContainer:c}),e.widgetControls[o]=a,(h=function(){(wp.customize?s.parent().hasClass("expanded"):s.hasClass("open"))?a.initializeEditor():setTimeout(h,50)})()))},e.setupAccessibleMode=function(){var i,s,r,n,a;i=t(".editwidget > form"),0!==i.length&&(s=i.find("> .widget-control-actions > .id_base").val(),-1!==e.idBases.indexOf(s)&&(n=t("<div></div>"),a=i.find("> .widget-inside"),a.before(n),r=new e.CustomHtmlWidgetControl({el:n,syncContainer:a}),r.initializeEditor()))},e.handleWidgetUpdated=function(t,i){var s,r,n,a;s=i.find("> .widget-inside > .form, > .widget-inside > form"),a=s.find("> .id_base").val(),-1!==e.idBases.indexOf(a)&&(r=s.find("> .widget-id").val(),(n=e.widgetControls[r])&&n.updateFields())},e.init=function(i){var s=t(document);_.extend(e.codeEditorSettings,i),s.on("widget-added",e.handleWidgetAdded),s.on("widget-synced widget-updated",e.handleWidgetUpdated),t(function(){var i;"widgets"===window.pagenow&&(i=t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function(){var i=t(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),t(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);