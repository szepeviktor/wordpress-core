!function(t){var e=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,handleCropToolClick:function(i,s,r){var n=t("#image-preview-"+i),a=this.iasapi.getSelection();isNaN(a.x1)&&(this.setCropSelection(i,{x1:0,y1:0,x2:n.innerWidth(),y2:n.innerHeight(),width:n.innerWidth(),height:n.innerHeight()}),a=this.iasapi.getSelection()),0===a.x1&&0===a.y1&&0===a.x2&&0===a.y2?(this.iasapi.setSelection(0,0,n.innerWidth(),n.innerHeight(),!0),this.iasapi.setOptions({show:!0}),this.iasapi.update()):e.crop(i,s,r)},intval:function(t){return 0|t},setDisabled:function(t,e){e?t.removeClass("disabled").prop("disabled",!1):t.addClass("disabled").prop("disabled",!0)},init:function(e){var i=this,s=t("#image-editor-"+i.postid),r=i.intval(t("#imgedit-x-"+e).val()),n=i.intval(t("#imgedit-y-"+e).val());i.postid!==e&&s.length&&i.close(i.postid),i.hold.w=i.hold.ow=r,i.hold.h=i.hold.oh=n,i.hold.xy_ratio=r/n,i.hold.sizer=parseFloat(t("#imgedit-sizer-"+e).val()),i.postid=e,t("#imgedit-response-"+e).empty(),t('input[type="text"]',"#imgedit-panel-"+e).keypress(function(e){var i=e.keyCode;if(36<i&&i<41&&t(this).blur(),13===i)return e.preventDefault(),e.stopPropagation(),!1})},toggleEditor:function(e,i){var s=t("#imgedit-wait-"+e);i?s.fadeIn("fast"):s.fadeOut("fast")},toggleHelp:function(e){var i=t(e);return i.attr("aria-expanded","false"===i.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(e){return t('input[name="imgedit-target-'+e+'"]:checked',"#imgedit-save-target-"+e).val()||"full"},scaleChanged:function(e,i,s){var r=t("#imgedit-scale-width-"+e),n=t("#imgedit-scale-height-"+e),a=t("#imgedit-scale-warn-"+e),o="",h="";!1!==this.validateNumeric(s)&&(i?(h=""!==r.val()?Math.round(r.val()/this.hold.xy_ratio):"",n.val(h)):(o=""!==n.val()?Math.round(n.val()*this.hold.xy_ratio):"",r.val(o)),h&&h>this.hold.oh||o&&o>this.hold.ow?a.css("visibility","visible"):a.css("visibility","hidden"))},getSelRatio:function(e){var i=this.hold.w,s=this.hold.h,r=this.intval(t("#imgedit-crop-width-"+e).val()),n=this.intval(t("#imgedit-crop-height-"+e).val());return r&&n?r+":"+n:i&&s?i+":"+s:"1:1"},filterHistory:function(e,i){var s,r,n,a,o=t("#imgedit-history-"+e).val(),h=[];if(""!==o){if(o=JSON.parse(o),(s=this.intval(t("#imgedit-undone-"+e).val()))>0)for(;s>0;)o.pop(),s--;if(i){if(!o.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";n=o[o.length-1],n=n.c||n.r||n.f||!1,n&&(this.hold.w=n.fw,this.hold.h=n.fh)}for(r in o)a=o[r],a.hasOwnProperty("c")?h[r]={c:{x:a.c.x,y:a.c.y,w:a.c.w,h:a.c.h}}:a.hasOwnProperty("r")?h[r]={r:a.r.r}:a.hasOwnProperty("f")&&(h[r]={f:a.f.f});return JSON.stringify(h)}return""},refreshEditor:function(i,s,r){var n,a,o=this;o.toggleEditor(i,1),n={action:"imgedit-preview",_ajax_nonce:s,postid:i,history:o.filterHistory(i,1),rand:o.intval(1e6*Math.random())},a=t('<img id="image-preview-'+i+'" alt="" />').on("load",{history:n.history},function(s){var n,o,h,d=t("#imgedit-crop-"+i),c=e;""!==s.data.history&&(h=JSON.parse(s.data.history),h[h.length-1].hasOwnProperty("c")&&(c.setDisabled(t("#image-undo-"+i),!0),t("#image-undo-"+i).focus())),d.empty().append(a),n=Math.max(c.hold.w,c.hold.h),o=Math.max(t(a).width(),t(a).height()),c.hold.sizer=n>o?o/n:1,c.initCrop(i,a,d),void 0!==r&&null!==r&&r(),t("#imgedit-history-"+i).val()&&"0"===t("#imgedit-undone-"+i).val()?t("input.imgedit-submit-btn","#imgedit-panel-"+i).removeAttr("disabled"):t("input.imgedit-submit-btn","#imgedit-panel-"+i).prop("disabled",!0),c.toggleEditor(i,0)}).on("error",function(){t("#imgedit-crop-"+i).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>"),o.toggleEditor(i,0)}).attr("src",ajaxurl+"?"+t.param(n))},action:function(e,i,s){var r,n,a,o,h,d=this;if(d.notsaved(e))return!1;if(r={action:"image-editor",_ajax_nonce:i,postid:e},"scale"===s){if(n=t("#imgedit-scale-width-"+e),a=t("#imgedit-scale-height-"+e),o=d.intval(n.val()),h=d.intval(a.val()),o<1)return n.focus(),!1;if(h<1)return a.focus(),!1;if(o===d.hold.ow||h===d.hold.oh)return!1;r["do"]="scale",r.fwidth=o,r.fheight=h}else{if("restore"!==s)return!1;r["do"]="restore"}d.toggleEditor(e,1),t.post(ajaxurl,r,function(i){t("#image-editor-"+e).empty().append(i),d.toggleEditor(e,0),d._view&&d._view.refresh()})},save:function(i,s){var r,n=this.getTarget(i),a=this.filterHistory(i,0),o=this;if(""===a)return!1;this.toggleEditor(i,1),r={action:"image-editor",_ajax_nonce:s,postid:i,history:a,target:n,context:t("#image-edit-context").length?t("#image-edit-context").val():null,"do":"save"},t.post(ajaxurl,r,function(s){var r=JSON.parse(s);if(r.error)return t("#imgedit-response-"+i).html('<div class="error"><p>'+r.error+"</p></div>"),void e.close(i);r.fw&&r.fh&&t("#media-dims-"+i).html(r.fw+" &times; "+r.fh),r.thumbnail&&t(".thumbnail","#thumbnail-head-"+i).attr("src",""+r.thumbnail),r.msg&&t("#imgedit-response-"+i).html('<div class="updated"><p>'+r.msg+"</p></div>"),o._view?o._view.save():e.close(i)})},open:function(i,s,r){this._view=r;var n,a=t("#image-editor-"+i),o=t("#media-head-"+i),h=t("#imgedit-open-btn-"+i),d=h.siblings(".spinner");if(!h.hasClass("button-activated"))return d.addClass("is-active"),n={action:"image-editor",_ajax_nonce:s,postid:i,"do":"open"},t.ajax({url:ajaxurl,type:"post",data:n,beforeSend:function(){h.addClass("button-activated")}}).done(function(t){a.html(t),o.fadeOut("fast",function(){a.fadeIn("fast"),h.removeClass("button-activated"),d.removeClass("is-active")}),e.init(i)})},imgLoaded:function(e){var i=t("#image-preview-"+e),s=t("#imgedit-crop-"+e);"undefined"==typeof this.hold.sizer&&this.init(e),this.initCrop(e,i,s),this.setCropSelection(e,{x1:0,y1:0,x2:0,y2:0,width:i.innerWidth(),height:i.innerHeight()}),this.toggleEditor(e,0),t(".imgedit-wrap .imgedit-help-toggle").eq(0).focus()},initCrop:function(i,s,r){var n,a=this,o=t("#imgedit-sel-width-"+i),h=t("#imgedit-sel-height-"+i);a.iasapi=t(s).imgAreaSelect({parent:r,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(e){n=t(e),n.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),r.children().on("mousedown, touchstart",function(t){var e,s,r=!1;t.shiftKey&&(e=a.iasapi.getSelection(),s=a.getSelRatio(i),r=e&&e.width&&e.height?e.width+":"+e.height:s),a.iasapi.setOptions({aspectRatio:r})})},onSelectStart:function(){e.setDisabled(t("#imgedit-crop-sel-"+i),1)},onSelectEnd:function(t,s){e.setCropSelection(i,s)},onSelectChange:function(t,i){var s=e.hold.sizer;o.val(e.round(i.width/s)),h.val(e.round(i.height/s))}})},setCropSelection:function(e,i){var s;if(!(i=i||0)||i.width<3&&i.height<3)return this.setDisabled(t(".imgedit-crop","#imgedit-panel-"+e),1),this.setDisabled(t("#imgedit-crop-sel-"+e),1),t("#imgedit-sel-width-"+e).val(""),t("#imgedit-sel-height-"+e).val(""),t("#imgedit-selection-"+e).val(""),!1;s={x:i.x1,y:i.y1,w:i.width,h:i.height},this.setDisabled(t(".imgedit-crop","#imgedit-panel-"+e),1),t("#imgedit-selection-"+e).val(JSON.stringify(s))},close:function(e,i){if((i=i||!1)&&this.notsaved(e))return!1;this.iasapi={},this.hold={},this._view?this._view.back():t("#image-editor-"+e).fadeOut("fast",function(){t("#media-head-"+e).fadeIn("fast",function(){t("#imgedit-open-btn-"+e).focus()}),t(this).empty()})},notsaved:function(e){var i=t("#imgedit-history-"+e).val(),s=""!==i?JSON.parse(i):[];return this.intval(t("#imgedit-undone-"+e).val())<s.length&&!confirm(t("#imgedit-leaving-"+e).html())},addStep:function(e,i,s){for(var r=this,n=t("#imgedit-history-"+i),a=""!==n.val()?JSON.parse(n.val()):[],o=t("#imgedit-undone-"+i),h=r.intval(o.val());h>0;)a.pop(),h--;o.val(0),a.push(e),n.val(JSON.stringify(a)),r.refreshEditor(i,s,function(){r.setDisabled(t("#image-undo-"+i),!0),r.setDisabled(t("#image-redo-"+i),!1)})},rotate:function(e,i,s,r){if(t(r).hasClass("disabled"))return!1;this.addStep({r:{r:e,fw:this.hold.h,fh:this.hold.w}},i,s)},flip:function(e,i,s,r){if(t(r).hasClass("disabled"))return!1;this.addStep({f:{f:e,fw:this.hold.w,fh:this.hold.h}},i,s)},crop:function(e,i,s){var r=t("#imgedit-selection-"+e).val(),n=this.intval(t("#imgedit-sel-width-"+e).val()),a=this.intval(t("#imgedit-sel-height-"+e).val());if(t(s).hasClass("disabled")||""===r)return!1;r=JSON.parse(r),r.w>0&&r.h>0&&n>0&&a>0&&(r.fw=n,r.fh=a,this.addStep({c:r},e,i))},undo:function(e,i){var s=this,r=t("#image-undo-"+e),n=t("#imgedit-undone-"+e),a=s.intval(n.val())+1;r.hasClass("disabled")||(n.val(a),s.refreshEditor(e,i,function(){var i=t("#imgedit-history-"+e),n=""!==i.val()?JSON.parse(i.val()):[];s.setDisabled(t("#image-redo-"+e),!0),s.setDisabled(r,a<n.length),n.length===a&&t("#image-redo-"+e).focus()}))},redo:function(e,i){var s=this,r=t("#image-redo-"+e),n=t("#imgedit-undone-"+e),a=s.intval(n.val())-1;r.hasClass("disabled")||(n.val(a),s.refreshEditor(e,i,function(){s.setDisabled(t("#image-undo-"+e),!0),s.setDisabled(r,a>0),0===a&&t("#image-undo-"+e).focus()}))},setNumSelection:function(e,i){var s,r,n,a,o,h=t("#imgedit-sel-width-"+e),d=t("#imgedit-sel-height-"+e),c=this.intval(h.val()),l=this.intval(d.val()),u=t("#image-preview-"+e),p=u.height(),m=u.width(),g=this.hold.sizer,f=this.iasapi;if(!1!==this.validateNumeric(i))return c<1?(h.val(""),!1):l<1?(d.val(""),!1):void(c&&l&&(s=f.getSelection())&&(a=s.x1+Math.round(c*g),o=s.y1+Math.round(l*g),r=s.x1,n=s.y1,a>m&&(r=0,a=m,h.val(Math.round(a/g))),o>p&&(n=0,o=p,d.val(Math.round(o/g))),f.setSelection(r,n,a,o),f.update(),this.setCropSelection(e,f.getSelection())))},round:function(t){var e;return t=Math.round(t),this.hold.sizer>.6?t:(e=t.toString().slice(-1),"1"===e?t-1:"9"===e?t+1:t)},setRatioSelection:function(e,i,s){var r,n,a=this.intval(t("#imgedit-crop-width-"+e).val()),o=this.intval(t("#imgedit-crop-height-"+e).val()),h=t("#image-preview-"+e).height();!1!==this.validateNumeric(s)&&a&&o&&(this.iasapi.setOptions({aspectRatio:a+":"+o}),(r=this.iasapi.getSelection(!0))&&(n=Math.ceil(r.y1+(r.x2-r.x1)/(a/o)),n>h&&(n=h,i?t("#imgedit-crop-height-"+e).val(""):t("#imgedit-crop-width-"+e).val("")),this.iasapi.setSelection(r.x1,r.y1,r.x2,n),this.iasapi.update()))},validateNumeric:function(e){if(!this.intval(t(e).val()))return t(e).val(""),!1}}}(jQuery);