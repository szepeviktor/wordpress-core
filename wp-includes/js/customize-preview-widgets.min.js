wp.customize.widgetsPreview=wp.customize.WidgetCustomizerPreview=function(t,e,i,s){var r;return r={renderedSidebars:{},renderedWidgets:{},registeredSidebars:[],registeredWidgets:{},widgetSelectors:[],preview:null,l10n:{widgetTooltip:""},selectiveRefreshableWidgets:{}},r.init=function(){var t=this;t.preview=s.preview,e.isEmpty(t.selectiveRefreshableWidgets)||t.addPartials(),t.buildWidgetSelectors(),t.highlightControls(),t.preview.bind("highlight-widget",t.highlightWidget),s.preview.bind("active",function(){t.highlightControls()}),s.preview.bind("refresh-widget-partial",function(e){var i="widget["+e+"]";s.selectiveRefresh.partial.has(i)?s.selectiveRefresh.partial(i).refresh():t.renderedWidgets[e]&&s.preview.send("refresh")})},r.WidgetPartial=s.selectiveRefresh.Partial.extend({initialize:function(t,i){var n,a=this;if(!(n=t.match(/^widget\[(.+)]$/)))throw new Error("Illegal id for widget partial.");a.widgetId=n[1],a.widgetIdParts=r.parseWidgetId(a.widgetId),i=i||{},i.params=e.extend({settings:[r.getWidgetSettingId(a.widgetId)],containerInclusive:!0},i.params||{}),s.selectiveRefresh.Partial.prototype.initialize.call(a,t,i)},refresh:function(){var e,i=this;return r.selectiveRefreshableWidgets[i.widgetIdParts.idBase]?s.selectiveRefresh.Partial.prototype.refresh.call(i):(e=t.Deferred(),e.reject(),i.fallback(),e.promise())},renderContent:function(t){var e=this;s.selectiveRefresh.Partial.prototype.renderContent.call(e,t)&&(s.preview.send("widget-updated",e.widgetId),s.selectiveRefresh.trigger("widget-updated",e))}}),r.SidebarPartial=s.selectiveRefresh.Partial.extend({initialize:function(t,i){var r,n=this;if(!(r=t.match(/^sidebar\[(.+)]$/)))throw new Error("Illegal id for sidebar partial.");if(n.sidebarId=r[1],i=i||{},i.params=e.extend({settings:["sidebars_widgets["+n.sidebarId+"]"]},i.params||{}),s.selectiveRefresh.Partial.prototype.initialize.call(n,t,i),!n.params.sidebarArgs)throw new Error("The sidebarArgs param was not provided.");if(n.params.settings.length>1)throw new Error("Expected SidebarPartial to only have one associated setting")},ready:function(){var t=this;e.each(t.settings(),function(i){s(i).bind(e.bind(t.handleSettingChange,t))}),s.selectiveRefresh.bind("partial-content-rendered",function(i){i.partial.extended(r.WidgetPartial)&&-1!==e.indexOf(t.getWidgetIds(),i.partial.widgetId)&&s.selectiveRefresh.trigger("sidebar-updated",t)}),s.bind("change",function(i){var s,n;(n=r.parseWidgetSettingId(i.id))&&(s=n.idBase,n.number&&(s+="-"+String(n.number)),-1!==e.indexOf(t.getWidgetIds(),s)&&t.ensureWidgetPlacementContainers(s))})},findDynamicSidebarBoundaryNodes:function(){var t,i,s=this,r={};return t=/^(dynamic_sidebar_before|dynamic_sidebar_after):(.+):(\d+)$/,i=function(n){e.each(n,function(n){var a;if(8===n.nodeType){if(!(a=n.nodeValue.match(t))||a[2]!==s.sidebarId)return;e.isUndefined(r[a[3]])&&(r[a[3]]={before:null,after:null,instanceNumber:parseInt(a[3],10)}),"dynamic_sidebar_before"===a[1]?r[a[3]].before=n:r[a[3]].after=n}else 1===n.nodeType&&i(n.childNodes)})},i(document.body.childNodes),e.values(r)},placements:function(){var t=this;return e.map(t.findDynamicSidebarBoundaryNodes(),function(e){return new s.selectiveRefresh.Placement({partial:t,container:null,startNode:e.before,endNode:e.after,context:{instanceNumber:e.instanceNumber}})})},getWidgetIds:function(){var t,i,r=this;if(!(t=r.settings()[0]))throw new Error("Missing associated setting.");if(!s.has(t))throw new Error("Setting does not exist.");if(i=s(t).get(),!e.isArray(i))throw new Error("Expected setting to be array of widget IDs");return i.slice(0)},reflowWidgets:function(){var t,i,r,n=this,a=[];return i=n.getWidgetIds(),t=n.placements(),r={},e.each(i,function(t){var e=s.selectiveRefresh.partial("widget["+t+"]");e&&(r[t]=e)}),e.each(t,function(t){var i,n=[],o=!1,h=-1;e.each(r,function(s){e.each(s.placements(),function(e){t.context.instanceNumber===e.context.sidebar_instance_number&&(i=e.container.index(),n.push({partial:s,placement:e,position:i}),i<h&&(o=!0),h=i)})}),o&&(e.each(n,function(e){t.endNode.parentNode.insertBefore(e.placement.container[0],t.endNode),s.selectiveRefresh.trigger("partial-content-moved",e.placement)}),a.push(t))}),a.length>0&&s.selectiveRefresh.trigger("sidebar-updated",n),a},ensureWidgetPlacementContainers:function(i){var n,a=this,o=!1,h="widget["+i+"]";return n=s.selectiveRefresh.partial(h),n||(n=new r.WidgetPartial(h,{params:{}})),e.each(a.placements(),function(s){var r,h;(r=e.find(n.placements(),function(t){return t.context.sidebar_instance_number===s.context.instanceNumber}))||(h=t(a.params.sidebarArgs.before_widget.replace(/%1\$s/g,i).replace(/%2\$s/g,"widget")+a.params.sidebarArgs.after_widget),h[0]&&(h.attr("data-customize-partial-id",n.id),h.attr("data-customize-partial-type","widget"),h.attr("data-customize-widget-id",i),h.data("customize-partial-placement-context",{sidebar_id:a.sidebarId,sidebar_instance_number:s.context.instanceNumber}),s.endNode.parentNode.insertBefore(h[0],s.endNode),o=!0))}),s.selectiveRefresh.partial.add(n),o&&a.reflowWidgets(),n},handleSettingChange:function(t,i){var n,a,o=this,h=[];if(i.length>0&&0===t.length||t.length>0&&0===i.length)return void o.fallback();n=e.difference(i,t),e.each(n,function(t){var i=s.selectiveRefresh.partial("widget["+t+"]");i&&e.each(i.placements(),function(t){(t.context.sidebar_id===o.sidebarId||t.context.sidebar_args&&t.context.sidebar_args.id===o.sidebarId)&&t.container.remove()}),delete r.renderedWidgets[t]}),a=e.difference(t,i),e.each(a,function(t){var e=o.ensureWidgetPlacementContainers(t);h.push(e),r.renderedWidgets[t]=!0}),e.each(h,function(t){t.refresh()}),s.selectiveRefresh.trigger("sidebar-updated",o)},refresh:function(){var i=this,r=t.Deferred();return r.fail(function(){i.fallback()}),0===i.placements().length?r.reject():(e.each(i.reflowWidgets(),function(t){s.selectiveRefresh.trigger("partial-content-rendered",t)}),r.resolve()),r.promise()}}),s.selectiveRefresh.partialConstructor.sidebar=r.SidebarPartial,s.selectiveRefresh.partialConstructor.widget=r.WidgetPartial,r.addPartials=function(){e.each(r.registeredSidebars,function(t){var e,i="sidebar["+t.id+"]";(e=s.selectiveRefresh.partial(i))||(e=new r.SidebarPartial(i,{params:{sidebarArgs:t}}),s.selectiveRefresh.partial.add(e))})},r.buildWidgetSelectors=function(){var e=this;t.each(e.registeredSidebars,function(i,s){var r,n,a,o=[s.before_widget,s.before_title,s.after_title,s.after_widget].join("");r=t(o),n=r.prop("tagName")||"",(a=r.prop("className")||"")&&(a=a.replace(/\S*%[12]\$s\S*/g,""),a=a.replace(/^\s+|\s+$/g,""),a&&(n+="."+a.split(/\s+/).join(".")),e.widgetSelectors.push(n))})},r.highlightWidget=function(e){var i=t(document.body),s=t("#"+e);i.find(".widget-customizer-highlighted-widget").removeClass("widget-customizer-highlighted-widget"),s.addClass("widget-customizer-highlighted-widget"),setTimeout(function(){s.removeClass("widget-customizer-highlighted-widget")},500)},r.highlightControls=function(){var e=this,i=this.widgetSelectors.join(",");s.settings.channel&&(t(i).attr("title",this.l10n.widgetTooltip),t(document).on("mouseenter",i,function(){e.preview.send("highlight-widget-control",t(this).prop("id"))}),t(document).on("click",i,function(i){i.shiftKey&&(i.preventDefault(),e.preview.send("focus-widget-control",t(this).prop("id")))}))},r.parseWidgetId=function(t){var e,i={idBase:"",number:null};return e=t.match(/^(.+)-(\d+)$/),e?(i.idBase=e[1],i.number=parseInt(e[2],10)):i.idBase=t,i},r.parseWidgetSettingId=function(t){var e,i={idBase:"",number:null};return(e=t.match(/^widget_([^\[]+?)(?:\[(\d+)])?$/))?(i.idBase=e[1],e[2]&&(i.number=parseInt(e[2],10)),i):null},r.getWidgetSettingId=function(t){var e,i=this.parseWidgetId(t);return e="widget_"+i.idBase,i.number&&(e+="["+String(i.number)+"]"),e},s.bind("preview-ready",function(){t.extend(r,_wpWidgetCustomizerPreviewSettings),r.init()}),r}(jQuery,_,wp,wp.customize);