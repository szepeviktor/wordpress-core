tinymce.PluginManager.add("wpeditimage",function(t){function e(e){return!(!t.dom.getAttrib(e,"data-mce-placeholder")&&!t.dom.getAttrib(e,"data-mce-object"))}function i(e){var i=t.$(e).parents("[contenteditable]");return i&&"false"===i.attr("contenteditable")}function s(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,i,s){var r,n,a,o,h,d;return r=i.match(/id=['"]([^'"]*)['"] ?/),r&&(i=i.replace(r[0],"")),n=i.match(/align=['"]([^'"]*)['"] ?/),n&&(i=i.replace(n[0],"")),a=i.match(/class=['"]([^'"]*)['"] ?/),a&&(i=i.replace(a[0],"")),d=i.match(/width=['"]([0-9]*)['"] ?/),d&&(i=i.replace(d[0],"")),s=f(s),h=s.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i),h&&h[2]?(o=f(h[2]),h=f(h[1])):(o=f(i).replace(/caption=['"]/,"").replace(/['"]$/,""),h=s),r=r&&r[1]?r[1].replace(/[<>&]+/g,""):"",n=n&&n[1]?n[1]:"alignnone",a=a&&a[1]?" "+a[1].replace(/[<>&]+/g,""):"",!d&&h&&(d=h.match(/width=['"]([0-9]*)['"]/)),d&&d[1]&&(d=d[1]),d&&o?(d=parseInt(d,10),t.getParam("wpeditimage_html5_captions")||(d+=10),'<div class="mceTemp"><dl id="'+r+'" class="wp-caption '+n+a+'" style="width: '+d+'px"><dt class="wp-caption-dt">'+h+'</dt><dd class="wp-caption-dd">'+o+"</dd></dl></div>"):s})}function r(t){return t.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(t,e){var i="";return-1===e.indexOf("<img ")||-1!==e.indexOf("</p>")?e.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(i=e.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(t,e,i,s){var r,n,a,o;return o=i.match(/width="([0-9]*)"/),o=o&&o[1]?o[1]:"",n=e.match(/class="([^"]*)"/),n=n&&n[1]?n[1]:"",a=n.match(/align[a-z]+/i)||"alignnone",o&&s?(r=e.match(/id="([^"]*)"/),r=r&&r[1]?r[1]:"",n=n.replace(/wp-caption ?|align[a-z]+ ?/gi,""),n&&(n=' class="'+n+'"'),s=s.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(t){return t.replace(/[\r\n\t]+/," ")}),s=s.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+r+'" align="'+a+'" width="'+o+'"'+n+"]"+i+" "+s+"[/caption]"):("alignnone"!==a[0]&&(i=i.replace(/><img/,' class="'+a[0]+'"><img')),i)}),-1===i.indexOf("[caption")&&(i=e.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),i)})}function n(e){var i,s,r,n,a,o,h,d,c=[],l=t.dom,u=/^\d+$/;return r={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},r.url=l.getAttrib(e,"src"),r.alt=l.getAttrib(e,"alt"),r.title=l.getAttrib(e,"title"),h=l.getAttrib(e,"width"),d=l.getAttrib(e,"height"),(!u.test(h)||parseInt(h,10)<1)&&(h=e.naturalWidth||e.width),(!u.test(d)||parseInt(d,10)<1)&&(d=e.naturalHeight||e.height),r.customWidth=r.width=h,r.customHeight=r.height=d,i=tinymce.explode(e.className," "),s=[],tinymce.each(i,function(t){/^wp-image/.test(t)?r.attachment_id=parseInt(t.replace("wp-image-",""),10):/^align/.test(t)?r.align=t.replace("align",""):/^size/.test(t)?r.size=t.replace("size-",""):s.push(t)}),r.extraClasses=s.join(" "),n=l.getParents(e,".wp-caption"),n.length&&(n=n[0],i=n.className.split(" "),tinymce.each(i,function(t){/^align/.test(t)?r.align=t.replace("align",""):t&&"wp-caption"!==t&&c.push(t)}),r.captionClassName=c.join(" "),a=l.select("dd.wp-caption-dd",n),a.length&&(a=a[0],r.caption=t.serializer.serialize(a).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),e.parentNode&&"A"===e.parentNode.nodeName&&(o=e.parentNode,r.linkUrl=l.getAttrib(o,"href"),r.linkTargetBlank="_blank"===l.getAttrib(o,"target"),r.linkRel=l.getAttrib(o,"rel"),r.linkClassName=o.className),r}function a(t){return t&&!!(t.textContent||t.innerText).replace(/\ufeff/g,"")}function o(e){return!e||-1===e.indexOf("<")&&-1===e.indexOf(">")?e:(u||(u=new tinymce.html.Serializer({},t.schema)),u.serialize(t.parser.parse(e,{forced_root_block:!1})))}function h(e,i){var s,r,n,h,d,c,l,u,p,m,g,f,_,v,y,w,b,x,A,k=t.dom;s=tinymce.explode(i.extraClasses," "),s||(s=[]),i.caption||s.push("align"+i.align),i.attachment_id&&(s.push("wp-image-"+i.attachment_id),i.size&&"custom"!==i.size&&s.push("size-"+i.size)),v=i.width,y=i.height,"custom"===i.size&&(v=i.customWidth,y=i.customHeight),f={src:i.url,width:v||null,height:y||null,title:i.title||null,"class":s.join(" ")||null},k.setAttribs(e,f),t.$(e).attr("alt",i.alt||""),_={href:i.linkUrl,rel:i.linkRel||null,target:i.linkTargetBlank?"_blank":null,"class":i.linkClassName||null},e.parentNode&&"A"===e.parentNode.nodeName&&!a(e.parentNode)?i.linkUrl?k.setAttribs(e.parentNode,_):k.remove(e.parentNode,!0):i.linkUrl&&((l=k.getParent(e,"a"))&&k.insertAfter(e,l),l=k.create("a",_),e.parentNode.insertBefore(l,e),l.appendChild(e)),u=t.dom.getParent(e,".mceTemp"),n=e.parentNode&&"A"===e.parentNode.nodeName&&!a(e.parentNode)?e.parentNode:e,i.caption?(i.caption=o(i.caption),g=i.attachment_id?"attachment_"+i.attachment_id:null,w="align"+(i.align||"none"),r="wp-caption "+w,i.captionClassName&&(r+=" "+i.captionClassName.replace(/[<>&]+/g,"")),t.getParam("wpeditimage_html5_captions")||(v=parseInt(v,10),v+=10),u?(m=k.select("dl.wp-caption",u),m.length&&k.setAttribs(m,{id:g,"class":r,style:"width: "+v+"px"}),p=k.select(".wp-caption-dd",u),p.length&&k.setHTML(p[0],i.caption)):(g=g?'id="'+g+'" ':"",h="<dl "+g+'class="'+r+'" style="width: '+v+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+i.caption+"</dd></dl>",c=k.create("div",{"class":"mceTemp"},h),(d=k.getParent(n,"p"))?d.parentNode.insertBefore(c,d):n.parentNode.insertBefore(c,n),t.$(c).find("dt.wp-caption-dt").append(n),d&&k.isEmpty(d)&&k.remove(d))):u&&(d=k.create("p"),u.parentNode.insertBefore(d,u),d.appendChild(n),k.remove(u)),b=t.$(e),x=b.attr("srcset"),A=b.attr("src"),x&&A&&(A=A.replace(/[?#].*/,""),-1===x.indexOf(A)&&b.attr("srcset",null).attr("sizes",null)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:t,metadata:i,image:e}),t.nodeChanged()}function d(e){var i,s,r;if("undefined"==typeof wp||!wp.media)return void t.execCommand("mceImage");r=n(e),wp.media.events.trigger("editor:image-edit",{editor:t,metadata:r,image:e}),i=wp.media({frame:"image",state:"image-details",metadata:r}),wp.media.events.trigger("editor:frame-create",{frame:i}),s=function(s){t.focus(),t.undoManager.transact(function(){h(e,s)}),i.detach()},i.state("image-details").on("update",s),i.state("replace-image").on("replace",s),i.on("close",function(){t.focus(),i.detach()}),i.open()}function c(e){var i=t.dom.getParent(e,"div.mceTemp");i||"IMG"!==e.nodeName||(i=t.dom.getParent(e,"a")),i?(i.nextSibling?t.selection.select(i.nextSibling):i.previousSibling?t.selection.select(i.previousSibling):t.selection.select(i.parentNode),t.selection.collapse(!0),t.dom.remove(i)):t.dom.remove(e),t.nodeChanged(),t.undoManager.add()}var l,u,p,m,g=tinymce.each,f=tinymce.trim,_=tinymce.Env.iOS;return t.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){c(t.selection.getNode())}}),t.addButton("wp_img_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",onclick:function(){d(t.selection.getNode())}}),g({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(e,i){var s=i.slice(5);t.addButton("wp_img_"+i,{tooltip:e,icon:"dashicon dashicons-align-"+s,cmd:"alignnone"===i?"wpAlignNone":"Justify"+s.slice(0,1).toUpperCase()+s.slice(1),onPostRender:function(){var e=this;t.on("NodeChange",function(s){var r;"IMG"===s.element.nodeName&&(r=t.dom.getParent(s.element,".wp-caption")||s.element,"alignnone"===i?e.active(!/\balign(left|center|right)\b/.test(r.className)):e.active(t.dom.hasClass(r,i)))})}})}),t.once("preinit",function(){t.wp&&t.wp._createToolbar&&(l=t.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),t.on("wptoolbar",function(t){"IMG"!==t.element.nodeName||e(t.element)||(t.toolbar=l)}),_&&t.on("init",function(){t.on("touchstart",function(t){"IMG"!==t.target.nodeName||i(t.target)||(p=!0)}),t.dom.bind(t.getDoc(),"touchmove",function(){p=!1}),t.on("touchend",function(e){if(p&&"IMG"===e.target.nodeName&&!i(e.target)){var s=e.target;p=!1,window.setTimeout(function(){t.selection.select(s),t.nodeChanged()},100)}else l&&l.hide()})}),t.on("init",function(){var e=t.dom,i=t.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";e.addClass(t.getBody(),i),tinymce.Env.ie&&tinymce.Env.ie>10&&e.bind(t.getBody(),"mscontrolselect",function(i){"IMG"===i.target.nodeName&&e.getParent(i.target,".wp-caption")?t.getBody().focus():"DL"===i.target.nodeName&&e.hasClass(i.target,"wp-caption")&&i.target.focus()})}),t.on("ObjectResized",function(e){var i=e.target;"IMG"===i.nodeName&&t.undoManager.transact(function(){var s,r,n=t.dom;i.className=i.className.replace(/\bsize-[^ ]+/,""),(s=n.getParent(i,".wp-caption"))&&(r=e.width||n.getAttrib(i,"width"))&&(r=parseInt(r,10),t.getParam("wpeditimage_html5_captions")||(r+=10),n.setStyle(s,"width",r+"px"))})}),t.on("pastePostProcess",function(e){t.dom.getParent(t.selection.getNode(),"dd.wp-caption-dd")&&(t.$("img, audio, video, object, embed, iframe, script, style",e.node).remove(),t.$("*",e.node).each(function(e,i){t.dom.isBlock(i)&&(tinymce.trim(i.textContent||i.innerText)?(t.dom.insertAfter(t.dom.create("br"),i),t.dom.remove(i,!0)):t.dom.remove(i))}),t.$("br",e.node).each(function(e,i){i.nextSibling&&"BR"!==i.nextSibling.nodeName&&i.previousSibling&&"BR"!==i.previousSibling.nodeName||t.dom.remove(i)}),m=!0)}),t.on("BeforeExecCommand",function(e){var i,s,r,n,a,o,h=e.command,d=t.dom;if("mceInsertContent"===h||"Indent"===h||"Outdent"===h){if(i=t.selection.getNode(),o=d.getParent(i,"div.mceTemp")){if("mceInsertContent"!==h)return e.preventDefault(),e.stopImmediatePropagation(),!1;if(m)return void(m=!1);s=d.create("p"),d.insertAfter(s,o),t.selection.setCursorLocation(s,0),"IMG"===i.nodeName&&t.$(o).remove(),t.nodeChanged()}}else if("JustifyLeft"===h||"JustifyRight"===h||"JustifyCenter"===h||"wpAlignNone"===h){if(i=t.selection.getNode(),n="align"+h.slice(7).toLowerCase(),r=t.dom.getParent(i,".wp-caption"),"IMG"!==i.nodeName&&!r)return;i=r||i,a=t.dom.hasClass(i,n)?" alignnone":" "+n,i.className=f(i.className.replace(/ ?align(left|center|right|none)/g,"")+a),t.nodeChanged(),e.preventDefault(),l&&l.reposition(),t.fire("ExecCommand",{command:h,ui:e.ui,value:e.value})}}),t.on("keydown",function(e){var i,s,r,n,a=t.selection,o=e.keyCode,h=t.dom,d=tinymce.util.VK;if(o===d.ENTER)i=a.getNode(),(s=h.getParent(i,"div.mceTemp"))&&(h.events.cancel(e),tinymce.each(h.select("dt, dd",s),function(t){h.isEmpty(t)&&h.remove(t)}),n=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',r=h.create("p",null,n),"DD"===i.nodeName?h.insertAfter(r,s):s.parentNode.insertBefore(r,s),t.nodeChanged(),a.setCursorLocation(r,0));else if((o===d.DELETE||o===d.BACKSPACE)&&(i=a.getNode(),"DIV"===i.nodeName&&h.hasClass(i,"mceTemp")?s=i:"IMG"!==i.nodeName&&"DT"!==i.nodeName&&"A"!==i.nodeName||(s=h.getParent(i,"div.mceTemp")),s))return h.events.cancel(e),c(i),!1}),tinymce.Env.gecko&&t.on("undo redo",function(){"IMG"===t.selection.getNode().nodeName&&t.selection.collapse()}),t.wpSetImgCaption=function(t){return s(t)},t.wpGetImgCaption=function(t){return r(t)},t.on("beforeGetContent",function(e){"raw"!==e.format&&t.$('img[id="__wp-temp-img-id"]').attr("id",null)}),t.on("BeforeSetContent",function(e){"raw"!==e.format&&(e.content=t.wpSetImgCaption(e.content))}),t.on("PostProcess",function(e){e.get&&(e.content=t.wpGetImgCaption(e.content))}),function(){var e;t.on("dragstart",function(){var i=t.selection.getNode();"IMG"===i.nodeName&&((e=t.dom.getParent(i,".mceTemp"))||"A"!==i.parentNode.nodeName||a(i.parentNode)||(e=i.parentNode))}),t.on("drop",function(i){var s=t.dom,r=tinymce.dom.RangeUtils.getCaretRangeFromPoint(i.clientX,i.clientY,t.getDoc());r&&s.getParent(r.startContainer,".mceTemp")?i.preventDefault():e&&(i.preventDefault(),t.undoManager.transact(function(){r&&t.selection.setRng(r),t.selection.setNode(e),s.remove(e)})),e=null})}(),t.wp=t.wp||{},t.wp.isPlaceholder=e,{_do_shcode:s,_get_shcode:r}});