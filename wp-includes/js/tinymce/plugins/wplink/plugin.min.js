!function(t){t.ui.Factory.add("WPLinkPreview",t.ui.Control.extend({url:"#",renderHtml:function(){return'<div id="'+this._id+'" class="wp-link-preview"><a href="'+this.url+'" target="_blank" rel="noopener" tabindex="-1">'+this.url+"</a></div>"},setURL:function(e){var i,s;this.url!==e&&(this.url=e,e=window.decodeURIComponent(e),e=e.replace(/^(?:https?:)?\/\/(?:www\.)?/,""),-1!==(i=e.indexOf("?"))&&(e=e.slice(0,i)),-1!==(i=e.indexOf("#"))&&(e=e.slice(0,i)),e=e.replace(/(?:index)?\.html$/,""),"/"===e.charAt(e.length-1)&&(e=e.slice(0,-1)),""===e&&(e=this.url),e.length>40&&-1!==(i=e.indexOf("/"))&&-1!==(s=e.lastIndexOf("/"))&&s!==i&&(i+e.length-s<40&&(s=-(40-(i+1))),e=e.slice(0,i+1)+"\u2026"+e.slice(s)),t.$(this.getEl().firstChild).attr("href",this.url).text(e))}})),t.ui.Factory.add("WPLinkInput",t.ui.Control.extend({renderHtml:function(){return'<div id="'+this._id+'" class="wp-link-input"><input type="text" value="" placeholder="'+t.translate("Paste URL or type to search")+'" /><input type="text" style="display:none" value="" /></div>'},setURL:function(t){this.getEl().firstChild.value=t},getURL:function(){return t.trim(this.getEl().firstChild.value)},getLinkText:function(){var e=this.getEl().firstChild.nextSibling.value;return t.trim(e)?e.replace(/[\r\n\t ]+/g," "):""},reset:function(){var t=this.getEl().firstChild;t.value="",t.nextSibling.value=""}})),t.PluginManager.add("wplink",function(e){function i(){var t,i,s=e.selection.getStart(),r=e.dom.getParent(s,"a[href]");return r||(i=e.selection.getContent({format:"raw"}))&&-1!==i.indexOf("</a>")&&(t=i.match(/href="([^">]+)"/),t&&t[1]&&(r=e.$('a[href="'+t[1]+'"]',s)[0]),r&&e.selection.select(r)),r}function s(){e.$("a").each(function(t,i){var s=e.$(i);"_wp_link_placeholder"===s.attr("href")?e.dom.remove(i,!0):s.attr("data-wplink-edit")&&s.attr("data-wplink-edit",null)})}function r(t,e){return t.replace(/(<a [^>]+>)([\s\S]*?)<\/a>/g,function(t,i,s){return i.indexOf(' href="_wp_link_placeholder"')>-1?s:(e&&(i=i.replace(/ data-wplink-edit="true"/g,"")),(i=i.replace(/ data-wplink-url-error="true"/g,""))+s+"</a>")})}function n(t){var i=e.$(t),s=i.attr("href");s&&void 0!==p&&(v=!1,!/^http/i.test(s)||g.test(s)&&f.test(s)?i.removeAttr("data-wplink-url-error"):(v=!0,i.attr("data-wplink-url-error","true"),_(e.translate("Warning: the link has been inserted but may have errors. Please test it."),"assertive")))}var a,o,h,d,c,l,u,p=window.jQuery,m=/^(mailto:)?[a-z0-9._%+-]+@[a-z0-9][a-z0-9.-]*\.[a-z]{2,63}$/i,g=/^https?:\/\/([^\s\/?.#-][^\s\/?.#]*\.?)+(\/[^\s"]*)?$/i,f=/^https?:\/\/[^\/]+\.[^\/]+($|\/)/i,_="undefined"!=typeof window.wp&&window.wp.a11y&&window.wp.a11y.speak?window.wp.a11y.speak:function(){},v=!1;return e.on("preinit",function(){if(e.wp&&e.wp._createToolbar){a=e.wp._createToolbar(["wp_link_preview","wp_link_edit","wp_link_remove"],!0);var t=["wp_link_input","wp_link_apply"];"undefined"!=typeof window.wpLink&&t.push("wp_link_advanced"),o=e.wp._createToolbar(t,!0),o.on("show",function(){"undefined"!=typeof window.wpLink&&window.wpLink.modalOpen||window.setTimeout(function(){var t=o.$el.find("input.ui-autocomplete-input")[0],e=c&&(c.textContent||c.innerText);t&&(!t.value&&e&&"undefined"!=typeof window.wpLink&&(t.value=window.wpLink.getUrlFromSelection(e)),l||(t.focus(),t.select()))})}),o.on("hide",function(){o.scrolling||e.execCommand("wp_link_cancel")})}}),e.addCommand("WP_Link",function(){if(t.Env.ie&&t.Env.ie<10&&"undefined"!=typeof window.wpLink)return void window.wpLink.open(e.id);c=i(),o.tempHide=!1,c?e.dom.setAttribs(c,{"data-wplink-edit":!0}):(s(),e.execCommand("mceInsertLink",!1,{href:"_wp_link_placeholder"}),c=e.$('a[href="_wp_link_placeholder"]')[0],e.nodeChanged())}),e.addCommand("wp_link_apply",function(){if(!o.scrolling){var i,s;if(c){i=d.getURL(),s=d.getLinkText(),e.focus();var r=document.createElement("a");if(r.href=i,"javascript:"!==r.protocol&&"data:"!==r.protocol||(i=""),!i)return void e.dom.remove(c,!0);/^(?:[a-z]+:|#|\?|\.|\/)/.test(i)||m.test(i)||(i="http://"+i),e.dom.setAttribs(c,{href:i,"data-wplink-edit":null}),t.trim(c.innerHTML)||e.$(c).text(s||i),n(c)}d.reset(),e.nodeChanged(),"undefined"==typeof window.wpLinkL10n||v||_(window.wpLinkL10n.linkInserted)}}),e.addCommand("wp_link_cancel",function(){o.tempHide||(d.reset(),s())}),e.addCommand("wp_unlink",function(){e.execCommand("unlink"),o.tempHide=!1,e.execCommand("wp_link_cancel")}),e.addShortcut("access+a","","WP_Link"),e.addShortcut("access+s","","wp_unlink"),e.addShortcut("meta+k","","WP_Link"),e.addButton("link",{icon:"link",tooltip:"Insert/edit link",cmd:"WP_Link",stateSelector:"a[href]"}),e.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink"}),e.addMenuItem("link",{icon:"link",text:"Insert/edit link",cmd:"WP_Link",stateSelector:"a[href]",context:"insert",prependToContext:!0}),e.on("pastepreprocess",function(i){var s=i.content,r=/^(?:https?:)?\/\/\S+$/i;e.selection.isCollapsed()||r.test(e.selection.getContent())||(s=s.replace(/<[^>]+>/g,""),s=t.trim(s),r.test(s)&&(e.execCommand("mceInsertLink",!1,{href:e.dom.decode(s)}),i.preventDefault()))}),e.on("savecontent",function(t){t.content=r(t.content,!0)}),e.on("BeforeAddUndo",function(t){t.lastLevel&&t.lastLevel.content&&t.level.content&&t.lastLevel.content===r(t.level.content)&&t.preventDefault()}),e.on("keydown",function(i){27===i.keyCode&&e.execCommand("wp_link_cancel"),i.altKey||t.Env.mac&&(!i.metaKey||i.ctrlKey)||!t.Env.mac&&!i.ctrlKey||89!==i.keyCode&&90!==i.keyCode||(l=!0,window.clearTimeout(u),u=window.setTimeout(function(){l=!1},500))}),e.addButton("wp_link_preview",{type:"WPLinkPreview",onPostRender:function(){h=this}}),e.addButton("wp_link_input",{type:"WPLinkInput",onPostRender:function(){var i,s,r,n=this.getEl(),a=n.firstChild;d=this,p&&p.ui&&p.ui.autocomplete&&(i=p(a),i.on("keydown",function(){i.removeAttr("aria-activedescendant")}).autocomplete({source:function(t,e){return r===t.term?void e(s):/^https?:/.test(t.term)||-1!==t.term.indexOf(".")?e():(p.post(window.ajaxurl,{action:"wp-link-ajax",page:1,search:t.term,_ajax_linking_nonce:p("#_ajax_linking_nonce").val()},function(t){s=t,e(t)},"json"),void(r=t.term))},focus:function(t,e){i.attr("aria-activedescendant","mce-wp-autocomplete-"+e.item.ID),t.preventDefault()},select:function(t,e){return i.val(e.item.permalink),p(n.firstChild.nextSibling).val(e.item.title),9===t.keyCode&&"undefined"!=typeof window.wpLinkL10n&&_(window.wpLinkL10n.linkSelected),!1},open:function(){i.attr("aria-expanded","true"),o.blockHide=!0},close:function(){i.attr("aria-expanded","false"),o.blockHide=!1},minLength:2,position:{my:"left top+2"},messages:{noResults:"undefined"!=typeof window.uiAutocompleteL10n?window.uiAutocompleteL10n.noResults:"",results:function(t){if("undefined"!=typeof window.uiAutocompleteL10n)return t>1?window.uiAutocompleteL10n.manyResults.replace("%d",t):window.uiAutocompleteL10n.oneResult}}}).autocomplete("instance")._renderItem=function(t,e){var i="undefined"!=typeof window.wpLinkL10n?window.wpLinkL10n.noTitle:"",s=e.title?e.title:i;return p('<li role="option" id="mce-wp-autocomplete-'+e.ID+'">').append("<span>"+s+'</span>&nbsp;<span class="wp-editor-float-right">'+e.info+"</span>").appendTo(t)},i.attr({role:"combobox","aria-autocomplete":"list","aria-expanded":"false","aria-owns":i.autocomplete("widget").attr("id")}).on("focus",function(){var t=i.val();t&&!/^https?:/.test(t)&&i.autocomplete("search")}).autocomplete("widget").addClass("wplink-autocomplete").attr("role","listbox").removeAttr("tabindex").on("menufocus",function(t,e){e.item.attr("aria-selected","true")}).on("menublur",function(){p(this).find('[aria-selected="true"]').removeAttr("aria-selected")})),t.$(a).on("keydown",function(t){13===t.keyCode&&(e.execCommand("wp_link_apply"),t.preventDefault())})}}),e.on("wptoolbar",function(t){var i,s,r,n=e.dom.getParent(t.element,"a");if("undefined"!=typeof window.wpLink&&window.wpLink.modalOpen)return void(o.tempHide=!0);o.tempHide=!1,n?(i=e.$(n),s=i.attr("href"),r=i.attr("data-wplink-edit"),"_wp_link_placeholder"===s||r?("_wp_link_placeholder"===s||d.getURL()||d.setURL(s),t.element=n,t.toolbar=o):s&&!i.find("img").length&&(h.setURL(s),t.element=n,t.toolbar=a,"true"===i.attr("data-wplink-url-error")?a.$el.find(".wp-link-preview a").addClass("wplink-url-error"):(a.$el.find(".wp-link-preview a").removeClass("wplink-url-error"),v=!1))):o.visible()&&e.execCommand("wp_link_cancel")}),e.addButton("wp_link_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",cmd:"WP_Link"}),e.addButton("wp_link_remove",{tooltip:"Remove link",icon:"dashicon dashicons-editor-unlink",cmd:"wp_unlink"}),e.addButton("wp_link_advanced",{tooltip:"Link options",icon:"dashicon dashicons-admin-generic",onclick:function(){if("undefined"!=typeof window.wpLink){var i=d.getURL()||null,s=d.getLinkText()||null;t.Env.ie&&e.focus(),o.tempHide=!0,window.wpLink.open(e.id,i,s,c),d.reset()}}}),e.addButton("wp_link_apply",{tooltip:"Apply",icon:"dashicon dashicons-editor-break",cmd:"wp_link_apply",classes:"widget btn primary"}),{close:function(){o.tempHide=!1,e.execCommand("wp_link_cancel")},checkLink:n}})}(window.tinymce);