tinymce.PluginManager.add("wpgallery",function(t){function e(t){return t.replace(/\[gallery([^\]]*)\]/g,function(t){return i("wp-gallery",t)})}function i(t,e){return e=window.encodeURIComponent(e),'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem '+t+'" data-wp-media="'+e+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />'}function s(t){function e(t,e){return e=new RegExp(e+'="([^"]+)"').exec(t),e?window.decodeURIComponent(e[1]):""}return t.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(t,i){var s=e(i,"data-wp-media");return s?"<p>"+s+"</p>":t})}function r(e){var i,s,r;"IMG"===e.nodeName&&"undefined"!=typeof wp&&wp.media&&(r=window.decodeURIComponent(t.dom.getAttrib(e,"data-wp-media")),t.dom.hasClass(e,"wp-gallery")&&wp.media.gallery&&(i=wp.media.gallery,s=i.edit(r),s.state("gallery-edit").on("update",function(r){var n=i.shortcode(r).string();t.dom.setAttrib(e,"data-wp-media",window.encodeURIComponent(n)),s.detach()})))}t.addCommand("WP_Gallery",function(){r(t.selection.getNode())}),t.on("mouseup",function(e){function i(){s.removeClass(s.select("img.wp-media-selected"),"wp-media-selected")}var s=t.dom,n=e.target;"IMG"===n.nodeName&&s.getAttrib(n,"data-wp-media")?2!==e.button&&(s.hasClass(n,"wp-media-selected")?r(n):(i(),s.addClass(n,"wp-media-selected"))):i()}),t.on("ResolveName",function(e){var i=t.dom,s=e.target;"IMG"===s.nodeName&&i.getAttrib(s,"data-wp-media")&&i.hasClass(s,"wp-gallery")&&(e.name="gallery")}),t.on("BeforeSetContent",function(i){t.plugins.wpview&&"undefined"!=typeof wp&&wp.mce||(i.content=e(i.content))}),t.on("PostProcess",function(t){t.get&&(t.content=s(t.content))})});