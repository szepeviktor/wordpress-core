!function(t,e,i,s){"use strict";var r={},n={};e.mce=e.mce||{},e.mce.views={register:function(t,i){r[t]=e.mce.View.extend(_.extend(i,{type:t}))},unregister:function(t){delete r[t]},get:function(t){return r[t]},unbind:function(){_.each(n,function(t){t.unbind()})},setMarkers:function(t,e){var i,s,n=[{content:t}],a=this;return _.each(r,function(t,r){s=n.slice(),n=[],_.each(s,function(s){var o,h,d=s.content;if(s.processed)return void n.push(s);for(;d&&(o=t.prototype.match(d));)o.index&&n.push({content:d.substring(0,o.index)}),o.options.editor=e,i=a.createInstance(r,o.content,o.options),h=i.loader?".":i.text,n.push({content:i.ignore?h:'<p data-wpview-marker="'+i.encodedText+'">'+h+"</p>",processed:!0}),d=d.slice(o.index+o.content.length);d&&n.push({content:d})})}),t=_.pluck(n,"content").join(""),t.replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(t,e,i,s){var r,a,o=this.get(t);return-1!==e.indexOf("[")&&-1!==e.indexOf("]")&&(e=e.replace(/\[[^\]]+\]/g,function(t){return t.replace(/[\r\n]/g,"")})),!s&&(a=this.getInstance(e))?a:(r=encodeURIComponent(e),i=_.extend(i||{},{text:e,encodedText:r}),n[r]=new o(i))},getInstance:function(t){return"string"==typeof t?n[encodeURIComponent(t)]:n[s(t).attr("data-wpview-text")]},getText:function(t){return decodeURIComponent(s(t).attr("data-wpview-text")||"")},render:function(t){_.each(n,function(e){e.render(null,t)})},update:function(t,e,i,s){var r=this.getInstance(i);r&&r.update(t,e,i,s)},edit:function(t,e){var i=this.getInstance(e);i&&i.edit&&i.edit(i.text,function(s,r){i.update(s,t,e,r)})},remove:function(t,e){var i=this.getInstance(e);i&&i.remove(t,e)}},e.mce.View=function(t){_.extend(this,t),this.initialize()},e.mce.View.extend=Backbone.View.extend,_.extend(e.mce.View.prototype,{content:null,loader:!0,initialize:function(){},getContent:function(){return this.content},render:function(t,e){null!=t&&(this.content=t),t=this.getContent(),(this.loader||t)&&(e&&this.unbind(),this.replaceMarkers(),t?this.setContent(t,function(t,e){s(e).data("rendered",!0),this.bindNode.call(this,t,e)},!!e&&null):this.setLoader())},bindNode:function(){},unbindNode:function(){},unbind:function(){this.getNodes(function(t,e){this.unbindNode.call(this,t,e)},!0)},getEditors:function(t){_.each(tinymce.editors,function(e){e.plugins.wpview&&t.call(this,e)},this)},getNodes:function(t,e){this.getEditors(function(i){var r=this;s(i.getBody()).find('[data-wpview-text="'+r.encodedText+'"]').filter(function(){var t;return null==e||(t=!0===s(this).data("rendered"),e?t:!t)}).each(function(){t.call(r,i,this,this)})})},getMarkers:function(t){this.getEditors(function(e){var i=this;s(e.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){t.call(i,e,this)})})},replaceMarkers:function(){this.getMarkers(function(t,e){var i,r=e===t.selection.getNode();if(!this.loader&&s(e).text()!==tinymce.DOM.decode(this.text))return void t.dom.setAttrib(e,"data-wpview-marker",null);i=t.$('<div class="wpview wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'" contenteditable="false"></div>'),t.$(e).replaceWith(i),r&&setTimeout(function(){t.selection.select(i[0]),t.selection.collapse()})})},removeMarkers:function(){this.getMarkers(function(t,e){t.dom.setAttrib(e,"data-wpview-marker",null)})},setContent:function(t,e,i){_.isObject(t)&&(t.sandbox||t.head||-1!==t.body.indexOf("<script"))?this.setIframes(t.head||"",t.body,e,i):_.isString(t)&&-1!==t.indexOf("<script")?this.setIframes("",t,e,i):this.getNodes(function(i,s){t=t.body||t,-1!==t.indexOf("<iframe")&&(t+='<span class="mce-shim"></span>'),i.undoManager.transact(function(){s.innerHTML="",s.appendChild(_.isString(t)?i.dom.createFragment(t):t),i.dom.add(s,"span",{"class":"wpview-end"})}),e&&e.call(this,i,s)},i)},setIframes:function(i,r,n,a){var o=this;if(-1!==r.indexOf("[")&&-1!==r.indexOf("]")){var h=new RegExp("\\[\\/?(?:"+t.mceViewL10n.shortcodes.join("|")+")[^\\]]*?\\]","g");r=r.replace(h,function(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;")})}this.getNodes(function(t,a){function h(){var e;v||l.contentWindow&&(e=s(l),o.iframeHeight=s(p.body).height(),e.height()!==o.iframeHeight&&(e.height(o.iframeHeight),t.nodeChanged()))}function d(){t.isHidden()||(s(a).data("rendered",null),setTimeout(function(){e.mce.views.render()}))}function c(){g=new m(_.debounce(h,100)),g.observe(p.body,{attributes:!0,childList:!0,subtree:!0})}var l,u,p,m,g,f,v,y=t.dom,w="",b=t.getBody().className||"",x=t.getDoc().getElementsByTagName("head")[0];if(tinymce.each(y.$('link[rel="stylesheet"]',x),function(t){t.href&&-1===t.href.indexOf("skins/lightgray/content.min.css")&&-1===t.href.indexOf("skins/wordpress/wp-content.css")&&(w+=y.getOuterHTML(t))}),o.iframeHeight&&y.add(a,"span",{"data-mce-bogus":1,style:{display:"block",width:"100%",height:o.iframeHeight}},"\u200b"),t.undoManager.transact(function(){a.innerHTML="",l=y.add(a,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"},height:o.iframeHeight}),y.add(a,"span",{"class":"mce-shim"}),y.add(a,"span",{"class":"wpview-end"})}),l.contentWindow){if(u=l.contentWindow,p=u.document,p.open(),p.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+i+w+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}iframe {max-width: 100%;}</style></head><body id="wpview-iframe-sandbox" class="'+b+'">'+r+"</body></html>"),p.close(),o.iframeHeight&&(v=!0,setTimeout(function(){v=!1,h()},3e3)),s(u).on("load",h).on("unload",d),m=u.MutationObserver||u.WebKitMutationObserver||u.MozMutationObserver)p.body?c():p.addEventListener("DOMContentLoaded",c,!1);else for(f=1;f<6;f++)setTimeout(h,700*f);n&&n.call(o,t,a)}},a)},setLoader:function(t){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-'+(t||"admin-media")+'"></div><div class="wpview-loading"><ins></ins></div></div>')},setError:function(t,e){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(e||"no")+'"></div><p>'+t+"</p></div>")},match:function(t){var e=i.next(this.type,t);if(e)return{index:e.index,content:e.content,options:{shortcode:e.shortcode}}},update:function(t,i,n,a){_.find(r,function(r,o){var h=r.prototype.match(t);if(h)return s(n).data("rendered",!1),i.dom.setAttrib(n,"data-wpview-text",encodeURIComponent(t)),e.mce.views.createInstance(o,t,h.options,a).render(),i.selection.select(n),i.nodeChanged(),i.focus(),!0})},remove:function(t,e){this.unbindNode.call(this,t,e),t.dom.remove(e),t.focus()}})}(window,window.wp,window.wp.shortcode,window.jQuery),function(t,e,i,s){function r(e){var i={};return t.tinymce?!e||-1===e.indexOf("<")&&-1===e.indexOf(">")?e:(d=d||new t.tinymce.html.Schema(i),c=c||new t.tinymce.html.DomParser(i,d),l=l||new t.tinymce.html.Serializer(i,d),l.serialize(c.parse(e,{forced_root_block:!1}))):e.replace(/<[^>]+>/g,"")}var n,a,o,h,d,c,l;n={state:[],edit:function(t,e){var s=this.type,r=i[s].edit(t);this.pausePlayers&&this.pausePlayers(),_.each(this.state,function(t){r.state(t).on("update",function(t){e(i[s].shortcode(t).string(),"gallery"===s)})}),r.on("close",function(){r.detach()}),r.open()}},a=_.extend({},n,{state:["gallery-edit"],template:i.template("editor-gallery"),initialize:function(){var t=i.gallery.attachments(this.shortcode,i.view.settings.post.id),e=this.shortcode.attrs.named,s=this;t.more().done(function(){t=t.toJSON(),_.each(t,function(t){t.sizes&&(e.size&&t.sizes[e.size]?t.thumbnail=t.sizes[e.size]:t.sizes.thumbnail?t.thumbnail=t.sizes.thumbnail:t.sizes.full&&(t.thumbnail=t.sizes.full))}),s.render(s.template({verifyHTML:r,attachments:t,columns:e.columns?parseInt(e.columns,10):i.galleryDefaults.columns}))}).fail(function(t,e){s.setError(e)})}}),o=_.extend({},n,{action:"parse-media-shortcode",initialize:function(){var t=this,e=null;this.url&&(this.loader=!1,this.shortcode=i.embed.shortcode({url:this.text})),t.editor&&(e=t.editor.getBody().clientWidth),wp.ajax.post(this.action,{post_ID:i.view.settings.post.id,type:this.shortcode.tag,shortcode:this.shortcode.string(),maxwidth:e}).done(function(e){t.render(e)}).fail(function(e){t.url?(t.ignore=!0,t.removeMarkers()):t.setError(e.message||e.statusText,"admin-media")}),this.getEditors(function(e){e.on("wpview-selected",function(){t.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(t,e,i){var r=s("iframe.wpview-sandbox",i).get(0);r&&(r=r.contentWindow)&&r.mejs&&_.each(r.mejs.players,function(t){try{t.pause()}catch(e){}})})}}),h=_.extend({},o,{action:"parse-embed",edit:function(t,e){var s=i.embed.edit(t,this.url),r=this;this.pausePlayers(),s.state("embed").props.on("change:url",function(t,e){e&&t.get("url")&&(s.state("embed").metadata=t.toJSON())}),s.state("embed").on("select",function(){var t=s.state("embed").metadata;e(r.url?t.url:i.embed.shortcode(t).string())}),s.on("close",function(){s.detach()}),s.open()}}),e.register("gallery",_.extend({},a)),e.register("audio",_.extend({},o,{state:["audio-details"]})),e.register("video",_.extend({},o,{state:["video-details"]})),e.register("playlist",_.extend({},o,{state:["playlist-edit","video-playlist-edit"]})),e.register("embed",_.extend({},h)),e.register("embedURL",_.extend({},h,{match:function(t){var e=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi,i=e.exec(t);if(i)return{index:i.index+i[1].length,content:i[2],options:{url:!0}}}}))}(window,window.wp.mce.views,window.wp.media,window.jQuery);