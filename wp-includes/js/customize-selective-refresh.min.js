wp.customize.selectiveRefresh=function(t,e){"use strict";var i,s,r;return i={ready:t.Deferred(),editShortcutVisibility:new e.Value,data:{partials:{},renderQueryVar:"",l10n:{shiftClickToEdit:""}},currentRequest:null},_.extend(i,e.Events),s=i.Partial=e.Class.extend({id:null,defaults:{selector:null,primarySetting:null,containerInclusive:!1,fallbackRefresh:!0},initialize:function(e,i){var s=this;i=i||{},s.id=e,s.params=_.extend({settings:[]},s.defaults,i.params||i),s.deferred={},s.deferred.ready=t.Deferred(),s.deferred.ready.done(function(){s.ready()})},ready:function(){var e=this;_.each(e.placements(),function(s){t(s.container).attr("title",i.data.l10n.shiftClickToEdit),e.createEditShortcutForPlacement(s)}),t(document).on("click",e.params.selector,function(i){i.shiftKey&&(i.preventDefault(),_.each(e.placements(),function(s){t(s.container).is(i.currentTarget)&&e.showControl()}))})},createEditShortcutForPlacement:function(e){var i,s,r,n,a=this;e.container&&(s=t(e.container),r="head",n="area, audio, base, bdi, bdo, br, button, canvas, col, colgroup, command, datalist, embed, head, hr, html, iframe, img, input, keygen, label, link, map, math, menu, meta, noscript, object, optgroup, option, param, progress, rp, rt, ruby, script, select, source, style, svg, table, tbody, textarea, tfoot, thead, title, tr, track, video, wbr",!s.length||s.is(n)||s.closest(r).length||(i=a.createEditShortcut(),i.on("click",function(t){t.preventDefault(),t.stopPropagation(),a.showControl()}),a.addEditShortcutToPlacement(e,i)))},addEditShortcutToPlacement:function(e,i){var s=t(e.container);s.prepend(i),s.is(":visible")&&"none"!==s.css("display")||i.addClass("customize-partial-edit-shortcut-hidden")},getEditShortcutClassName:function(){var t=this;return"customize-partial-edit-shortcut-"+t.id.replace(/]/g,"").replace(/\[/g,"-")},getEditShortcutTitle:function(){var t=this,e=i.data.l10n;switch(t.getType()){case"widget":return e.clickEditWidget;case"blogname":case"blogdescription":return e.clickEditTitle;case"nav_menu":return e.clickEditMenu;default:return e.clickEditMisc}},getType:function(){var t,e=this;return t=e.params.primarySetting||_.first(e.settings())||"unknown",e.params.type?e.params.type:t.match(/^nav_menu_instance\[/)?"nav_menu":t.match(/^widget_.+\[\d+]$/)?"widget":t},createEditShortcut:function(){var e,i,s,r,n=this;return e=n.getEditShortcutTitle(),i=t("<span>",{"class":"customize-partial-edit-shortcut "+n.getEditShortcutClassName()}),s=t("<button>",{"aria-label":e,title:e,"class":"customize-partial-edit-shortcut-button"}),r=t('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13.89 3.39l2.71 2.72c.46.46.42 1.24.03 1.64l-8.01 8.02-5.56 1.16 1.16-5.58s7.6-7.63 7.99-8.03c.39-.39 1.22-.39 1.68.07zm-2.73 2.79l-5.59 5.61 1.11 1.11 5.54-5.65zm-2.97 8.23l5.58-5.6-1.07-1.08-5.59 5.6z"/></svg>'),s.append(r),i.append(s),i},placements:function(){var e,i=this;return e=i.params.selector||"",e&&(e+=", "),e+='[data-customize-partial-id="'+i.id+'"]',t(e).map(function(){var e,s=t(this);if(e=s.data("customize-partial-placement-context"),_.isString(e)&&"{"===e.substr(0,1))throw new Error("context JSON parse error");return new r({partial:i,container:s,context:e})}).get()},settings:function(){var t=this;return t.params.settings&&0!==t.params.settings.length?t.params.settings:t.params.primarySetting?[t.params.primarySetting]:[t.id]},isRelatedSetting:function(t){var i=this;return _.isString(t)&&(t=e(t)),!!t&&-1!==_.indexOf(i.settings(),t.id)},showControl:function(){var t=this,i=t.params.primarySetting;i||(i=_.first(t.settings())),"nav_menu"===t.getType()&&(t.params.navMenuArgs.theme_location?i="nav_menu_locations["+t.params.navMenuArgs.theme_location+"]":t.params.navMenuArgs.menu&&(i="nav_menu["+String(t.params.navMenuArgs.menu)+"]")),e.preview.send("focus-control-for-setting",i)},preparePlacement:function(e){t(e.container).addClass("customize-partial-refreshing")},_pendingRefreshPromise:null,refresh:function(){var t,e=this;return t=i.requestPartial(e),e._pendingRefreshPromise||(_.each(e.placements(),function(t){e.preparePlacement(t)}),t.done(function(t){_.each(t,function(t){e.renderContent(t)})}),t.fail(function(t,i){e.fallback(t,i)}),e._pendingRefreshPromise=t,t.always(function(){e._pendingRefreshPromise=null})),t},renderContent:function(e){var s,r,n=this;if(!e.container)return n.fallback(new Error("no_container"),[e]),!1;if(e.container=t(e.container),!1===e.addedContent)return n.fallback(new Error("missing_render"),[e]),!1;if(!_.isString(e.addedContent))return n.fallback(new Error("non_string_content"),[e]),!1;i.orginalDocumentWrite=document.write,document.write=function(){throw new Error(i.data.l10n.badDocumentWrite)};try{if(s=e.addedContent,wp.emoji&&wp.emoji.parse&&!t.contains(document.head,e.container[0])&&(s=wp.emoji.parse(s)),n.params.containerInclusive)r=t(s),e.context=_.extend(e.context,r.data("customize-partial-placement-context")||{}),r.data("customize-partial-placement-context",e.context),e.removedNodes=e.container,e.container=r,e.removedNodes.replaceWith(e.container),e.container.attr("title",i.data.l10n.shiftClickToEdit);else{for(e.removedNodes=document.createDocumentFragment();e.container[0].firstChild;)e.removedNodes.appendChild(e.container[0].firstChild);e.container.html(s)}e.container.removeClass("customize-render-content-error")}catch(a){"undefined"!=typeof console&&console.error&&console.error(n.id,a),n.fallback(a,[e])}return document.write=i.orginalDocumentWrite,i.orginalDocumentWrite=null,n.createEditShortcutForPlacement(e),e.container.removeClass("customize-partial-refreshing"),e.container.data("customize-partial-content-rendered",!0),wp.mediaelement&&wp.mediaelement.initialize(),wp.playlist&&wp.playlist.initialize(),i.trigger("partial-content-rendered",e),!0},fallback:function(){this.params.fallbackRefresh&&i.requestFullRefresh()}}),i.Placement=r=e.Class.extend({partial:null,container:null,startNode:null,endNode:null,context:null,addedContent:null,removedNodes:null,initialize:function(e){var i=this;if(e=_.extend({},e||{}),!e.partial||!e.partial.extended(s))throw new Error("Missing partial");e.context=e.context||{},e.container&&(e.container=t(e.container)),_.extend(i,e)}}),i.partialConstructor={},i.partial=new e.Values({defaultConstructor:s}),i.getCustomizeQuery=function(){var t={};return e.each(function(e,i){e._dirty&&(t[i]=e())}),{wp_customize:"on",nonce:e.settings.nonce.preview,customize_theme:e.settings.theme.stylesheet,customized:JSON.stringify(t),customize_changeset_uuid:e.settings.changeset.uuid}},i._pendingPartialRequests={},i._debouncedTimeoutId=null,i._currentRequest=null,i.requestFullRefresh=function(){e.preview.send("refresh")},i.requestPartial=function(s){var n;return i._debouncedTimeoutId&&(clearTimeout(i._debouncedTimeoutId),i._debouncedTimeoutId=null),i._currentRequest&&(i._currentRequest.abort(),i._currentRequest=null),n=i._pendingPartialRequests[s.id],n&&"pending"===n.deferred.state()||(n={deferred:t.Deferred(),partial:s},i._pendingPartialRequests[s.id]=n),s=null,i._debouncedTimeoutId=setTimeout(function(){var t,s,n,a;i._debouncedTimeoutId=null,t=i.getCustomizeQuery(),n={},s={},_.each(i._pendingPartialRequests,function(t,e){n[e]=t.partial.placements(),i.partial.has(e)?s[e]=_.map(n[e],function(t){return t.context||{}}):t.deferred.rejectWith(t.partial,[new Error("partial_removed"),n[e]])}),t.partials=JSON.stringify(s),t[i.data.renderQueryVar]="1",a=i._currentRequest=wp.ajax.send(null,{data:t,url:e.settings.url.self}),a.done(function(t){i.trigger("render-partials-response",t),t.errors&&"undefined"!=typeof console&&console.warn&&_.each(t.errors,function(t){console.warn(t)}),_.each(i._pendingPartialRequests,function(e,i){var s;_.isArray(t.contents[i])?(s=_.map(t.contents[i],function(t,s){var a=n[i][s];return a?a.addedContent=t:a=new r({partial:e.partial,addedContent:t}),a}),e.deferred.resolveWith(e.partial,[s])):e.deferred.rejectWith(e.partial,[new Error("unrecognized_partial"),n[i]])}),i._pendingPartialRequests={}}),a.fail(function(t,e){"abort"!==e&&(_.each(i._pendingPartialRequests,function(e,i){e.deferred.rejectWith(e.partial,[t,n[i]])}),i._pendingPartialRequests={})})},e.settings.timeouts.selectiveRefresh),n.deferred.promise()},i.addPartials=function(e,s){var n;e||(e=document.documentElement),e=t(e),s=_.extend({triggerRendered:!0},s||{}),n=e.find("[data-customize-partial-id]"),e.is("[data-customize-partial-id]")&&(n=n.add(e)),n.each(function(){var e,n,a,o,h,d,c=t(this);(a=c.data("customize-partial-id"))&&(d=c.data("customize-partial-placement-context")||{},e=i.partial(a),e||(h=c.data("customize-partial-options")||{},h.constructingContainerContext=c.data("customize-partial-placement-context")||{},o=i.partialConstructor[c.data("customize-partial-type")]||i.Partial,e=new o(a,h),i.partial.add(e)),s.triggerRendered&&!c.data("customize-partial-content-rendered")&&(n=new r({partial:e,context:d,container:c}),t(n.container).attr("title",i.data.l10n.shiftClickToEdit),e.createEditShortcutForPlacement(n),i.trigger("partial-content-rendered",n)),c.data("customize-partial-content-rendered",!0))})},e.bind("preview-ready",function(){var s,r,n;_.extend(i.data,_customizePartialRefreshExports),_.each(i.data.partials,function(t,e){var s,r=i.partial(e);r?_.extend(r.params,t):(s=i.partialConstructor[t.type]||i.Partial,r=new s(e,_.extend({params:t},t)),i.partial.add(r))}),s=function(t,e){var s=this;i.partial.each(function(i){i.isRelatedSetting(s,t,e)&&i.refresh()})},r=function(t){s.call(t,t(),null),t.bind(s)},n=function(t){s.call(t,null,t()),t.unbind(s)},e.bind("add",r),e.bind("remove",n),e.each(function(t){t.bind(s)}),i.addPartials(document.documentElement,{triggerRendered:!1}),"undefined"!=typeof MutationObserver&&(i.mutationObserver=new MutationObserver(function(e){_.each(e,function(e){i.addPartials(t(e.target))})}),i.mutationObserver.observe(document.documentElement,{childList:!0,subtree:!0})),e.selectiveRefresh.bind("partial-content-rendered",function(t){t.container&&i.addPartials(t.container)}),e.selectiveRefresh.bind("render-partials-response",function(t){t.setting_validities&&e.preview.send("selective-refresh-setting-validities",t.setting_validities)}),e.preview.bind("edit-shortcut-visibility",function(t){e.selectiveRefresh.editShortcutVisibility.set(t)}),e.selectiveRefresh.editShortcutVisibility.bind(function(e){var i,s=t(document.body);i="hidden"===e&&s.hasClass("customize-partial-edit-shortcuts-shown")&&!s.hasClass("customize-partial-edit-shortcuts-hidden"),s.toggleClass("customize-partial-edit-shortcuts-hidden",i),s.toggleClass("customize-partial-edit-shortcuts-shown","visible"===e)}),e.preview.bind("active",function(){i.partial.each(function(t){t.deferred.ready.resolve()}),i.partial.bind("add",function(t){t.deferred.ready.resolve()})})}),i}(jQuery,wp.customize);